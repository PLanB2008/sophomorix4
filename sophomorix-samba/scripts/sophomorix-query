#!/usr/bin/perl -w
# This script (sophomorix-query) is maintained by Rüdiger Beck
# It is Free Software (License GPLv3)
# If you find errors, contact the author
# jeffbeck@web.de  or  jeffbeck@linuxmuster.net

# modules
use strict;
#use Quota;
use Getopt::Long;
Getopt::Long::Configure ("bundling");
use Sophomorix::SophomorixConfig;
#use IMAP::Admin;
#use DBI;
use Net::LDAP;
use Data::Dumper;
$Data::Dumper::Indent = 1;
$Data::Dumper::Sortkeys = 1;
$Data::Dumper::Useqq = 1;
$Data::Dumper::Terse = 1; 

use Sophomorix::SophomorixBase qw(
                                 );
use Sophomorix::SophomorixSambaAD qw(
                                 AD_bind_admin
                                 AD_unbind_admin
                                    );

# Variablen für Optionen
$Conf::log_level=1;
my $help=0;

# Parsen der Optionen
my $testopt=GetOptions(
           "verbose|v+" => \$Conf::log_level,
           "help|h" => \$help
          );


# Prüfen, ob Optionen erkannt wurden, sonst Abbruch
#&check_options($testopt);

# --help
if ($help==1) {
   # Scriptname ermitteln
   my @list = split(/\//,$0);
   my $scriptname = pop @list;
   # Befehlsbeschreibung
   print('
sophomorix-query is a performance optimised was to query AD for users, computers and groups.

You can use wildcards (how?)


Options
  -h  / --help
  -v  / --verbose
  -vv / --verbose --verbose
  -i  / --info
  --filter: show the filter that is used

Search attribute(s) to find a user/group/computer:
(multiple options are connected with &)
--sam|sAMAccountName <string> 
--sn <string>
--gn|givenName  <string>
--anyname <string>      (All important name fieldssAMAccountName,sn,givenName, ...)

Limit the query for sophomorix users to a certain sophomorixRole:
(multiple options are connected with |)
--student        (sophomorixRole=student)
--teacher        (sophomorixRole=teacher)
--computer       (sophomorixRole=teacger)
... more Roles


Limit the query for sophomorix groups to a certain sophomorixType:
(multiple options are connected with |)
--adminclass          (sophomorixType=adminclass)
--extraclass          (sophomorixType=extraclass)
--teacherclass        (sophomorixType=teacherclass)
--class               (| (sophomorixType=adminclass)(sophomorixType=extraclass)(sophomorixType=teacherclass) )
--project             (sophomorixType=project)
--sophomorix-group    (sophomorixType=sophomorix-group)
... more Types


Performance improvements:

Limit the searchbase (this is faster):
--schoolbase <school> (limit the searchbase to one school or global)
  Maybe later:
  --sub-projectbase (only works together with schoolbase)


What attributes to give back of a user:
--samonly    (i. E. for dropdown menues)
--basic      (default)
--full       (all attributes)
--members    (add members if object is a group)


What attributes to give back of a group:
--grp-samonly      (i. E. for dropdown menues)
--grp-basic        (default)
--grp-full         (all attributes)
--grp-members      (add members if object is a group)


What attributes to give back of a group:
--comp-samonly    (i. E. for dropdown menues)
--comp-basic      (default)
--comp-full       (all attributes)
--what more?


Maybe:
What to query (objectclass, should be implied with the options above):
--oc-user      (an object with the objectclass user)
--oc-group     (an object with the objectclass group)
--oc-computer  (an object with the objectclass computer)
--> Ist this faster?


Examples:
  Search for all adminclasses and extraclassses of a school for dropdown menue:
  sophomorix-query --schoolbase <school> --extraclass --adminclass --samonly

  Search for all users (with data for listing) in a group with the name <7a>:
  sophomorix-query --schoolbase <school> --sam 7a --grp-samonly --group-members --full


Please see the sophomorix-query(8) man pages for full documentation
');
   print "\n";
   exit;
}


my ($ldap,$root_dse) = &AD_bind_admin();

############################################################


print "TEST\n";



############################################################
# END: Test code goes here
############################################################

&AD_unbind_admin($ldap);

