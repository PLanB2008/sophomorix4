Projekte:
ldap-Feld: keep members on move (TRUE/FALSE)
Benutzer im Projelkt lassen bem versetzen oder nicht
R. Schajor

SophomorixComment auch für Gruppen?
script sophomorix-comment im alle abweichenden Kommentare zu sehen?

sophomorix.add, ...
testen was ist wenn die Dateien nicht konfiguriert sind,
aber user auftreten: einfach zeile ignorieren


Neues Attribut im ldap:
OK: sophomorixAdminFile students.csv, abc.students.csv, ...
    ? updaten, wenn user in anderem File auftaucht? -> Ja

Kommentarfeld zu einem User:

sophomorix tests: SophomorixAdminFile checken

OK: sophomorixComment
OK: default: "created by sophomorix"
--> Wieviel Platz hat man in so einem Feld?
--> sophomorix user --show comments:
    Zeigt alle (non default) Kommentare

Bugs after moving to xenial
- membeships of the default groups are not correct
   --> add tests

- migration:
first test if 
remove group teachers first in classes.sh if existing
then recreate it with uid=10000
or: add gobal and  



wbinfo:
wbinfo -u    (listet alle user)
wbinfo -g    (listet alle groups)

'Zeile' aus passwd
   wbinfo -i USER
   wbinfo --user-info=USERNAME
'Zeile' aus group
wbinfo --group-info=GROUPNAME

Alle gidnumbers of user
wbinfo -r USER
wbinfo --user-groups=USER

wbinfo --pam-logon=sch42%'LinuxMuster!' (test pam login)
wbinfo --krb5auth=sch42%'LinuxMuster!'  (authenticat using kerberos)

wbinfo --all-domains
   BUILTIN
   LINUXMUSTER




Questions:
show/hidden bei klassen ist Attribut
(es gibt keine hiddenclass mehr)

Gibts irgendwas, was man quotieren müsste?
  Printerdaten? Seiten? pykota
  Schulkonsole Liste  
-> neu attribute im ldap erforderlich, welche

-> Überlegen

flag für adminclass: teacher
oder type=teacher (statt adminclass)
wenn eine gruppe für einen user mit der rolle teacher anlegt wird, dann ists eine solche

samba4 Fragen:
Gibts Useranzahlbeschränkung?
User und Gruppennamen gleich? Geht das?

DNS:

wie testet man, obs tut?

Schulkonsole: 
Wo soll aufgeschrieben werden, wie user usw. abgefragt werden müssen, ...
-> --porcelain output

Idee:

machine parsable output für Listen, ...
--------------------------------------------------
Vorbild: git ... --porcelain
-> im human readable output auch FARBEN verwendbar für output

sub &message("error|warning|info",porcelain=1|0,$value);

Bei Liste Titelzeile, was an welcher Stelle was steht 
(z.B. ldapAttributname)

Ansprechpartner für Format: Kai W.
--------------------------------------------------


ext4 als Standard 


drucker in devices.txt mit anderer nummer


/etc/linuxmuster/printers in ldap nehmen?


index definieren im schema


id_mapping zeigen

# ldbsearch -H /var/lib/samba/private/idmap.ldb

Edit idmap.ldb: (https://wiki.samba.org/index.php/User_and_Group_management)

UID-Mapping:
1) Find sid with
   # wbinfo --name-to-sid <user>
   # wbinfo -n <user>
   ---> sid
2) # wbinfo --sid-to-uid <sid from 1)>
   # wbinfo -S <sid from 1)>
   ---> uidnumber
3) ldbedit -e emacs -H /var/lib/samba/private/idmap.ldb objectsid=<sid from 1)>


GID-Mapping
4) # wbinfo --user-sids=<usersid from 1)>
   The first is the user sid
   Then group sids follow



NT_STATUS_INVALID_SID
siehe https://lists.samba.org/archive/samba-technical/2011-November/080319.html



libnns winbind tut nicht

uidnumbers:

Todo: im ldap abspeichern/abrufen (momentan in /etc/sophomorix/user/...)

- bei mirgation die ale setzen (uidNumber und gidNumer)
- beim neu anzulegenden user, ein eigenen Zähler hochzählen
  limit.
  (Defaultmäsig beginnen uidNumber/gidNumer bei etwa 3.000.000)
   Bei jedem ausgeführten id-Befehl wird die uidnumber um 2 erhöht.
   (scheinbar wird sie dynamisch erzeugt) 
  gruppe/user:
     gidnumer/uidnumer: gidNumber
     msSFU30NisDomain: linuxmuster ( bei LINUXMUSER.LOCAL)

Tests nach migration:

- OK: Bei welchen/wievielen Usern kann man sich mit dem firstpassword einloggen
  sophomorix-passwd --test-firstpassword

- uidNumber und gidNumber testen mit:
  id user (output parsen) und mit den Daten vor der Migration vergleichen
  -> Fehler melden: 

- Dürfen unix gid und uid dieselben vorkommen? 





funktion create userlist neu schreiben:

parameter:

loginnamenliste
klassenliste (auch lehrer)
alle role students
alle role teacher
default: eingeschränkt alle ou's



Idee:

viele befehle brauchen eine ou als option

sinnvoll wäre:

wenn mehrschulsystem konfiguriert ist, 
dann wird in den Befehlen die option --ou gefordert
ODER: 1) es wird IMMER ou gefordert
      2) wenn man nur eine hat, kann eine defeult OU in der config gesetzt werden 



############################################################
Schema
############################################################

Questions:

lDAPDisplayName  (wird zum befüllen benutzt)
adminDisplayName (tut nicht)


Changes:
1) ----------------------------------------
creationdate
tolerationdate
deactivationdate

oMSyntax 23 (Zeit) --> oMSyntax 64 (utf8 string)
attributeSyntax: 2.5.5.11 --> attributeSyntax: 2.5.5.12

See: https://technet.microsoft.com/en-us/library/cc961740.aspx

Benamung/Unterscheidung:

mailquota bei user mailquota
(Oder kann dasselbe attribut nochmals verwendet werden?)

mailalias bei user? oder kann diese Mailadresse schon eingetragen werden


############################################################
Set password age
############################################################

soll man das machen:

samba-tool domain passwordsettings set --max-pwd-age 0


############################################################
Set password of administrator
############################################################

samba-tool user setpassword Administrator

############################################################
DNS
############################################################

* Alle bisherigen abfragen??:
samba-tool dns query localhost linuxmuster.local @ ALL -U administrator --password='Muster!'

* DNS-Einträge anlegen:
  # samba-tool dns add localhost linuxmuster.local j1010-p01 A 10.16.100.1 --password='Muster!' -U Administrator
                               

  This adds: DN: DC=j1010-p01,DC=linuxmuster.local,CN=MicrosoftDNS,DC=DomainDnsZones,DC=linuxmuster,DC=local
  More??? where ist the IP 10.16.1.100 in ldap
  


  # samba-tool dns zonecreate localhost 100.16.10.in-addr.arpa --password='Muster!' -U Administrator
         100.16.10  -> Erste 3 Oktetts in umgekehrter Reihenfolge
                    10 bleibt
                    0,16,32,48,...  
                       -> Momentan: 2. oktett der server IP (IP aus Datei)
                       -> Final: aus den setup-Daten /var/linuxmuster, ... legt thomas eine zonendatei an.
                    100 kommt von der Rechner IP

  # samba-tool dns add localhost 100.16.10.in-addr.arpa 1 PTR j1010-p01.linuxmuster.lokal --password=Muster! -U Administrator


#INFO# samba-tool dns serverinfo localhost
samba-tool dns zoneinfo localhost 100.16.10.in-addr.arpa --password='Muster!' -U Administrator


Tests:
apt-get install dns-utils

dig j1010-p01
nslookup



lehrer.txt : eindeutige id nutzen


############################################################
Tree
############################################################





Forbidden OU's: SCHOOL, GLOBAL
Forbidden tokens: global, ---

############################################################
Migration:
############################################################


Three steps:
1) DUMP: run sophomorix-dump on old server
    (dumps to /root/sophomorix-dump)
2) copy the dir /root/sophomorix-dump recursively to new server/stick
3) SUCK IT IN: sophomorix-vampire --datadir /path/to/dumped/dir

to do: add option --restore-config-files (update wiki)
   use config file instead of list in script
test sophomorix-dump on school server
sophomorix dump: warn when target dir exists

role hiddenclass?
bz is in forbidden login hash -> /etc/group
   -> sophomorix-add shows show with option -i name clashes from fixed uidnames
log when a user cannot be created (summary in the end of script)
use project dump to create projects (is all info there)

add encrypted passwords to sophomorix.add
old: 
   userpassword          {SSHA}oTOa69my8cTkVa97XVDVeiJr3Ctmd0JHeS9RMC5SUkV4cElzQmlDa2k5QWtBdjFPek1Dbw== 
                         {CRYPT}QByepZzk6naTo
   sambalmpassword
      FFCA9D16DCB26848AAD3B435B51404EE
   sambantpassword
      CA7D70A5587A194B83A4C4D325ED1C44
new: 
   unicodePwd
  
Migration:

die mit AD_ou_add angelegten gruppen müssen eine gid bekommen
teachers: 10000 bei migration


add ldif file that updates
unicodePwd AND sophomorixFirstPassword
add option to sophomorix-vampire

Tasks to do after migration:
projects: add displayname

Bugs after Migration tests: 
------------------------------
sophomoriy-user cannot show  

sophomorix-project -i -p mkk_abt3
WARNING: sce seen twice! Remove one of them!

agoruom ist a workstation

sophomorix-class -i -c klasse:
- zeigt das user als member raus müssen.

nach sophomorix.add muss 

#-> und die admins aus 
#   sophomorix-dump/data/root/sophomorix-dump-viewdumps/memberdata_view.sql
#   nach sophomorixAdmins
#   (mit dem sophomorix-Befehl)
#-> alle mit adminclass teacher sind admins in der gid
#   wenn user, die nicht in adminclass teachers sind in anderen gruppen admins sind,
#   ---> script erzeugen um diese nachzutragen

############################################################
Scripts
############################################################

Allgemein:

Man kann wohl nicht eine unicode string mit "" (empty) füllen
-> Attribute entfernen? wenn --comment ""
-> oder was sonst reinschreiben?




AD_group_addmember
 add user to group only if they are not member already
 add group to group only if they are not member already


sophomorix-project

add groups with role 'project'
  - p_name (no school_token).
  - projects can contain students of all schools
  - project name length
  - p_longname: description field used
  - Zeitanzeige lesbarer machen (-i -p <name>)

Oberstufenkurse, wahlweise mit der ID
http://www.linuxmuster.net/wiki/anwenderwiki:sophomorix:sophomorix-project
  - zusammen mit dem Schlerdatenexport  auch oberstufenexport exportieren
  - sync betrachten




Tests:

if user is admin and should be member -> degrade user
if user is member and should be admin -> upgrade user
           member AND admin -> throw error
dito for groups

--members/admins  nonexisting user -> dont add user 


option sync memberships: go throuh all projects and sync memberships


sophomorix-user
 OK: options to change status
     Todo: update dates
 option to list new teachers
how to handle users that are organised in wrong school
  i.e. sophomorisSchoolname is BSZLEO an they are in OU=SCHOOL 

sophomorix-class
(migrate similar to projects)
- add option to create class (like*-project) --create
  --hide (sets type adminclass to hiddenclass)
  --quota
  --mailquota
  --mailalia
  --maillist
  --description ?  "migrated on $date"  
  --admins
  --admingroups
  (members are managed automatically)
create tests for that (sophomorix-test-4)

count current members (CM) and show then with -i option before MM
or one column: CM/MM -> 32/0

display type (T=teacher3,S=students)
display hidden

--info to display that (show classes like projects now)
sophomorix-vampire creates missung groups:
  --> hiddenclasses
  --> classes without students
  ---> and updates them (i.e. groups created by sophmorix-add)
Think about: create classes first, then the users automatically (avoids name clash)

add --info --class <class>


-> sophomorix-device

macadress in den ldap: https://msdn.microsoft.com/en-us/library/windows/desktop/ms676850%28v=vs.85%29.aspx


add/move/kill
-> logfiles adding, deletion, killing
-> Option -i: 
     - add a table per OU/token 
     - kill user markes with K

sophomorix-kill:
  list of groups tha will never be Killed
  - attic
  - teachers
  - students
  - Windows administrators groups

sophomorix-project
  -> create all groups with role=project
 
Attributes for a group

adding users:
  when role student, then put them in subcontainer CN=class,CN=students


document format of
sophomorix.add, .move, .kill
   - use utf8 in these files 




sophomorix-useradd
  - replace default password 'linux' with 'LinuxMuster!'
  - maybe put all options for adding users  to sophomorix-add

sophomorix-add:   
call sophomorix-print correctly 
--user --comment "" does not work ()
--user --webui-dashboard "" does not work

sophomorix.add:
-> are there umlaute allowed in sophomorix.add at the moment?
- expect sophomorix.add as utf8 encoded with umlaute and others

-> Additional fields 
     DONE school_token
     DONE ou 


sophomorix-print:

     - Full utf8 support
       (Firstnames, Surnames will be utf8 encoded)
     - add support for templates
       see pull requests for sophomorix2



############################################################
all scripts
############################################################

wenn man mit * sucht: 
sophomorix-class -i -c class1*
sophomorix-project -i -c pro*
soll das auch gehen

soll das auch für Änderungen gehen?

CSV-Tags entfernen:
grep '\$Id\$' -ir ./


when die (file missing), tell what file is missing 

show ldap search filer on -v (loglevel =>2)

/usr/sbin/sophomorix-class started ... usw: in loglevel -v verschieben

############################################################
Janitor scripts
############################################################

check if user is in more groups of type class