https cloning:

# cloning via https:
(git clone https://github.com/linuxmuster/sophomorix4.git)

# add https origin
git remote add https-origin https://github.com/linuxmuster/sophomorix4.git

# fetching via https (no passwird needed)
git pull https-origin xenial

# pushing via https
git push https-origin xenial
Username for 'https://github.com': ########
Password for 'https://jeffbeck@github.com': ########

ini Dateien:
------------------------------------------------------------
	var=Value
	list=SCHOOLS=bsz,abc,...
	key-value=key1=value1,key2=value2,... 
AK:
Win 10, wie sichtbar, wer angemeldet ist.

linbo webui:
- kernel-parameter als drop-down mit beschreibung wozu
  (... fix for Motherboard xyz)

kommentare in devices.csv erhalten

Übungsfirmen als Schulen
Lehrernetz schülernetz-Trennung

Landesschülerid -attribut vorsehen

Schulkonsole:
Umgang mit Tauschlaufwerken:
- Inhalt löschen| Inhalt ReadOnly noch x Tage zeigen, ...
  (evtl. als Lehrer)
- schülerhome nur ro als Lehrer
- Button um Lehrer am schuljahresende aus allen Klassen zu entfernen

Nextcloud:



sophomorix-mail
* sorgt dafür dass
  * mailaccounts da sind
  * mailinglisten da sind
Egalwo Mail gehostet wird, gleiches prinzipielles vorgehen:
1) AD-Abfrage: 
   * wer ist in welcher Gruppe
   --> JSON
   --> schon umsetzbar
Individueller Teil:
2) school.ini:
   welche Art wird benutzt
   [mail]
       MAILTYPE = belwue
       MAILTYPE = mailman
       .....
       --> sucht automatisch nach einer Datei <MAILTYPE>.conf im schulordner
       Dort dann jeweils das was man braucht:
        - passwort remote server
        - konfiguration, ...
        - .....
   Abfrage Maildienst
   A) Belwue über webinterface
   B) ...
3) Erstellen von Resultatdateien
   - zu erstellende Dateien (bewlue, Mailman, ....)
4) synchronisation
   A) Belwue mit links und passwort der admin interfaces
   B) scp upload
   C)...





NEXT/Todo:

searchFlags (0=public, 128=confidential)

ldbedit -H /var/lib/samba/private/sam.ldb CN=Sophomorix-First-Password searchflags --option="dsdb:schema update allowed=yes" -b "cn=schema,CN=configuration,DC=...,DC=..."

* ist leider etwas umständlich
* überlebt einen reboot
* wird global verändert (alle Schulen)?
* wie geht das/geht das mit ldap-modify?


- neues Paket:
  school/share (dito global)
  school/program (dito global)
  sophomorixWebuiPermissions
  sophomorixMailQuotaCalculated
  mail-attribut wird gefüllt

AD attribute
webui
   * sophomorixWebuiDashboard (voerst single lassen
   * sophomorixWebuiDashboardCalculated (vorerst weglassen)
   OK: sophomorixUserPermissions -> sophomorixWebuiPermissions (multi)
   todo: sophomorixWebuiPermissionsCalculated multi
mailquota:
    OK: sophomorixMailQuota             individueler Wert für user/gruppe
    OK: sophomorixMailQuotaCalculated   berechnet für dovecot (oder andere )
        NUR beim user


comment zu mailquota Angaben

mailquota umsetzen (in sophomorix-quota)

testen ob bei developersetquota auch comments gehen,
wird der user auch upgedated?

ordner share,program
OK 1) parallel zu management,students,teachers in jeder Schule und global
Todo   2) dann paket
Todo   3)anschließend ntacl abernten


mounten

root@server:/# mkdir -p /srv/samba/mounts/default-school

root@server:/# mount -t cifs -o user=administrator,pass=`cat /etc/linuxmuster/.secret/administrator`,domain=linuxmuster //linuxmuster.lan/default-school /srv/samba/mounts/default-school/

sophomorix-school --mount <share>
....
-> 



ACL:

* Tests für project acl
* nichtlöschbar fehlt noch
* examgroup fehlt noch, examuser, ...


SMB-shares
school shares anlegen scripten:
1) lokal -> scripten
2) share existiert
   sophomorix-repair --school aufrufen
(bisher: schule wird repariert bevor user angelegt werden)
3) quotatest

Bug:
sophomorix-add -j soll auch json Return Objekt ausgeben, wenn nix anzulegen ist.
dito -update, -add.....

sophomorix-quota:

Testen ob project sum richtig kalkuliert wird

upzudatende user hochzählen, progress objekt, das 1/23 anzeigt

sophomorix-project
sophomorix-class
bei Option -i, die Quota angaben (mit Comments, UNTER die Mitgliedersummierung),
ganze Zeile verwenden

sophomorix-class -i 
sophomorix-group -i 
* user zählen
* --min-user <num> --max-user <num>


sophomorix-quota 
show comments with sophomorix-quota -iv
* tests schreiben
* use loglevel for printout of projects


* sophomorix-check -ij: check which schools have a working smb file server
  * exit with error, when a user would be created
* sophomorix-quota: test if quota can be set
* sophomorix-school: test for school
  test if quota are enable
  ... -F OK smbshare responds
  ob quota enabled sind: parsen des Outputs
  


toolbox script to query as ordinary user
check if confidential attribute is hidden
deploy confidential attribute further



Bug:
beim locken
#### sophomorix locked (/usr/sbin/sophomorix-add, PID: 2389)              ####
Process with PID 2389 is still running
Process with PID 2389 is still running
Process with PID 2389 is still running
Process with PID 2389 is still running
Process with PID 2389 is still running
#### try again later ...                                                  ####
Undefined subroutine &Sophomorix::SophomorixAPI::fetch_error_string called at /usr/share/perl5/Sophomorix/SophomorixBase.pm line 1532.



###########################################################
Entwicklertreffen:

Mailserver.
wird per ssh mit eingerichtet
  --mailserver IP
    --> wenn ja mailserver setup 
    --> Paket: linuxmuster-mail
besteht aus (Docker):
-dovecut

-mailman extra dazu

Docker:
container unter /var/lib/docker/...
daten unter /srv/docker/linuxmuster-mail
c't-Artikel lesen

sophomorix-gruppe
Gruppe mail anlegen


Mailattribute
attribut mail  -> Füllen  loginname@linuxmuster.net ()
proxyAdresses  - multivalue, noch leer
mailAdresses


paketserver:
- weiterhin mit minidinstall
  synchronisation nach
  
  deb http://schmitt.linuxmuster.org/lmn7/ /
  deb http://fleischsalat.linuxmuster.org/lmn7/ /

viertelstündlich

nicenstein 


-- mehrschullösung
   1 Mailserver für alle schulen, gleiche maildomain (vorerst)




sophomorix-webui user permissions, genauer
sophomorix-school --check
   - sophomorix schaut, ob diese Schule existiert
   - Woran erkennbar?
      - Achtung: nur smb:// Befehle benutzen, da das share remote liegen könnte
      - es gibt ein smb-share mit dem Schulnamen
        (ein paar Namen für Schulen sind deshalb verboten, welche?)
      - in dem smb-share befindet sich toplevel eine Datei aquota.user
        (Sieht man die Datei im smb-share)
      - Tests:
         - kann sophomorix eine Datei anlegen? smbclient
         - kann sophomorix eine NTACL setzen?  smbcacls
         - kann sophomorix quota setzen?       smbcquota
   - Wenn share nutzbar --> Schüler werden angelegt
     sonst Abbruch BEVOR was gemacht wird:
     Zur Schule <school> gibt es kein smb-share 

5. Feld angleichen (lehrer,schüler)
   A) schueler.txt an lehrer.txt/extraschueler:
      5. Feld wunschlogin, 6. Feld unid
      Problem:
         - Schüler-Export ändert sich zur 6.x
	 - Schüler export braucht Leerfeld (problematisch)
	 - Migration
   B) lehrer.txt/extraschueler an schueler.txt
      5.Feld unid, 6. Feld wunschlogin
      Problem:
         - lehrer-export ändert sich zur 6.x
	 - Lehrerexport braucht Leerfeld
	 - Migration
   Beides aufwendig und betrifft auch
   - den workfow an den Schulen (Sekretariat Verwaltung, ...)
     schwierig umzustellen
   - Pakete, Fortbildungen, Beispieldateien, ...
   - das ganze ohne jeglichen Mehrwert, Zusatzfeature
   ---> Besser Finger weg.
        SK solte sich den langjährigen Gegebenheiten anpassen.
	Fallunterscheidung lehrer/extraschueler und schueler
	(sophomorix-check -ij gibt die Infos)
        

------------------------------------------------------------
Schulkonsolen-konfiguration
(SK=Schulkonsole(eine von vielen), Webui=Ajenti, ...):

Ziele:
- auch weitere schulkonsolen managebar
- Individuelle modulkonfiguration ermöglichen
- SK-debian-Paket soll (ohne sophomorix-update)
  - neues modul forcen können
  - neues modul auswählbar machen können 

Umsetzung:
1) Pfad zur Konfigurationsdatei </pfad/festlegen/<Webui>.conf>
  - Diese Datei ist im Schulkonsolenpaket, von Entwickler verwaltet

  - Beispiel Konfigurationsdatei des Pakets (je modul 1 Zeile)
    A) DEFAULT module werden angezeigt, wenn der admin sie nicht sperrt
       (z.B. neue, getestete module herausbringen)
       DEFAULT|<modulname>|<Zeile>
       (Beispiel: DEFAULT|auth-users|sidebar.view:/view/auth-users:true)
    B) MUST module werden angezeigt und können nicht gesperrt werden
       (z.B. selbstausperren verhindern)
       MUST|<modulname>|<Zeile>
    C) MAY module können angezeigt werden, wenn der admin das konfiguriert
       (z.B. module testen)
       MAY|<modulname>|<Zeile>

    * <modulname> ist der name unter dem dieses Modul in der
      school.ini, bei Optionen usw. angesprochen werden kann.
      (Vorschlag: keine Leerzeichen, kleinbuchstaben)


3) Sperren/Blockieren der Module bei der Rolle in der school.ini
[role.student]
	webui_show=modulname1,modulname2
	webui_block=modulname1,modulname2
[role.teacher]
	webui_show=modulname1,modulname2
	webui_block=modulname1,modulname2
[role.administrator]
	webui_show=modulname1,modulname2
	webui_block=modulname1,modulname2


Script sophomorix-sk (schulkonsole??)

Aufruf:
sophomorix-sk --info
  zeigt in jeder Schule, welche module wie konfiguriert sind
sophomorix-sk --ui <Webui>
              --school <schule>
              --role <student|teacher|administrator>
  konfiguriert für die sk <Webui> in der Schule <schule> für
  alle user der Rolle <student|teacher|administrator> die zu
  <Webui> gehörenden Attribute im AD.

  A) liest die Paket-Konfiguration der SK ein <Webui>
  B) modifiziert die Einstellungen entsprechend der school.ini
  C) schreibt die attribute für alle user neu
      ? Dauer
      ? später auf eine Schule einschränkbar
      ? später auf eine Rolle einschränkbar
      ? evtl. nur die Differenzen schreiben



Weitere Schulkonsole (z.B. 'miniui') hinzufügen wäre simple:
A) Felder im AD schema anlegen sophomorix-miniui (multivalue)
B) Pfad zur neuen SK-Konfigurationsdatei
   -> config.developer
   -> Attributnamen der Zielattribute Konfigurieren
   
C) Neue parameter in school.ini zulassen:

Konfiguration bei der Rolle, z.B.
[role.student]
	miniui_show=modulname1,modulname2
	miniui_block=modulname1,modulname2
	
Todo:
1) default schulkonsolennamen festlegen(Groß/klein beachten): Webui
   ---> so ÜBERALL verwenden
        (Dateinamen, Optionsnamen, Attribute, ...)
2) Attibute im Schema anpassen:
   ---> Sophomorix-Webui-Dashboard            singlevalue
   ---> Sophomorix-(Webui)-User-Permissions   multivalue -> todo
        wird je nach Rolle befüllt, 1 Zeile 1 Value

Fragen:
1) Was kommt in dieses Attribut, und wie findet sophomorix den Inhalt:
   Sophomorix-Webui-Dashboard            singlevalue
   -> Zusatz-Paket-konfigurationsdatei???
2) Brauchen andere schulkonsolen auch dieses Attribut??


------------------------------------------------------------
WIDERSPRUCH:
single-user einstellungen in school.ini oder AD?

2 unterschiedliche Methoden sind angedacht, auf welche einigen?

1) festplattenquota, mailquota, ...:
   sophomorix-quota trägt die Werte ins AD ein.
   (nicht in eine Textdatei)
   Falls beim user der Quota-Wert nicht leer ist
   wird er benutzt um defaultquota, klassenquota zu überschreiben
  

2) schulkonsolenmodule
   default aus school.ini, sophomorix schreibt bei JEDEM user die Werte ins AD rein.
   Individuelle module nicht vorgesehen, aber notwendig
   (modul testen, modul verbieten, ...)
   Individuelle Werte:
   A) In school.ini z.B. mit
      [users]
	webui_show=user1=modulname1,modulname2,user2=modulname2,
	webui_block=user1=modulname1,modulname2
      --> problematsch:
        - sehr school.ini/lange Zeilen,
	  (quota sollte dann eigentlich auch in school.ini)
        - school.ini aus der Produktion nicht mehr so einfach kopierbar,
	  da sie individuelle Einstellungen enthält
   B) ins AD
      wie erkennbar, dass ein user individuelle module sieht?
      --> Zusatzattribut in AD
          Sophomorix-Webui-Custom=TRUE/FALSE
	  (in Anlehnung an quota sollte es dieses Attribut auch für
	   Klassen/Projekte geben)

Generelle Idee:
Einstellungen (quota,SK-module, ...) habe folgende hierachie

serverweit
    --> globalweit
    --> schulweit
          --> rollenweit (begrenzte Anzahl)
	      --> Gruppenweit
	          (Klassenweit/Projektweit unbegrenzte Anzahl)
	         --> Individuell (user)
Vorschlag:
1) school.ini:
      Vorgaben für die ganze Schule
      Vorgaben für eine Rolle
   AD:
      Vorgaben für eine Gruppe
      Vorgaben für einen user

2) sophomorix-quota/mailquota/sk (module) berechnet für jeden user:
   - entsprechend der Schule/Rolle/Gruppe einen Wert, der für den user gilt:
   - die kann individuell überschrieben werden, wenn ein FlagAttribut beim
     user gesetzt wird (sophomorixQuotaCustom=TRUE/FALSE)

3) im entsprechenden USER-Attribut
        SophomorixQuota
        SophomorixMailquota
        Sophomorix-(Webui)-User-Permissions
     steht dann IMMER der finale Wert.

siehe auch Managementgroups:
wäre wohl besser deren defaultmembers im AD bei der Gruppe zu speichern

------------------------------------------------------------


Attribute Quota als Multivalue name:wert

sophomorix-group
          -class
	  -project
  How to display multiple quota in a single line?
    -> cancel that, use only yes or no (---)
    -> add number of users and groups
    -i -p/-c name: Spalten für quota breiter
    linuxmuster-global umbenennen


Moodle Testzugriff Stefan
Arbeitskreis
- ACL, Windows-Clients, Linux-Clients???
  Rainer, Buch kopiert mit sssd
  Domänenbeitritt ja, Auswirkung auf linbo

confidential: nicht schulweise
sondern Mitgied in Gruppe

sophomorix-device return json (import von Thomas auch)
 WebUI rechte via Sophomorix (LDAP)

CUPS via Samba
wer macht das?




Setup mit Partition =Schule
-> lvm, usw...
   sollte in die Doku von Linuxmuster-base


#####################################
LVM einrichten

pvcreate /dev/xvdb
vgcreate srv /dev/xvdb

lvcreate -L 10G -n default-school srv
mkfs.ext4 /dev/srv/default-school
mkdir -p /srv/samba/schools/default-school

lvcreate -L 30G -n linbo srv
mkfs.ext4 /dev/srv/linbo
mkdir -p /srv/linbo

lvcreate -l +100%FREE -n global srv
mkfs.ext4 /dev/srv/global
mkdir -p /srv/samba/global

## /etc/fstab
/dev/srv/default-school /srv/samba/schools/default-school  ext4  defaults       0       0
/dev/srv/linbo /srv/linbo       ext4  defaults       0       0
/dev/srv/global /srv/samba/global       ext4  defaults       0       0
##############################################


-> Wann geht sophomorix von einer funktionierende Schule aus?,
   -> gemountete Partition?
   -> aquota.user existiert?
   --> soll ja schnell gehen, oder 

ext4 und 1 smbshare=1 partition
Ubuntu 17.10 Base
-> key nicht aktuell
-> vor entwicklertreffen testen

############################################################
Entwicklertreffen
- Hardwareclasses
  als attribut (-> ja, für scripte)
  als Gruppe?
- MAC-Adresse? wohin im AD, vorgesehenes attribut von MS?
Info:
unicodePwd: kann nicht direkt gesetzt werden
 der Wert unicodePwd wird mit Net::LDAP dem samba4-server im
 Klartext übergeben (firstpassword), der samba4 server speichert es gehasht ab
sophomorix-mamagementgroup
- brauchts die optionen --admins/--noadmins ?
   -> alladmins oder <schulname>-admin?
   wie macht man einen Lehrer zum admin, global-admin?
   sophomorix-admin ??
   muss der dann in alladmins und <schulname>-admins

Ersetzungen:
   ADMINLIST, woran erkennt man admins
   Schulweite config oder Systemweite config:
   URLSCHUKO 
   URLMOODLE
   URLMAIL

Mail:
2 Alternativen?:
 -> belwue mail(zusatzpaket sophomorix-belwue-mail)
    zusätzlicher Admin?
    
 -> Eigene Mail, aber was (Anbindung an AD, Mailinglisten, Aliase)
    - Docker mit postfix, dovecot: fürjeden user mailadresse
    - Mailinglisten mit mailman (von AD userlisten holen)

Firewall:Opensense

OK: sophomorix-passwd -u ... --pass .... sollte tun
???: interaktiv
???: altes passwort gilt noch weiter
???: passwort change tests in tests
???: return correct error in JSON from samba when password ist too simple or too short
???: dito when resetting password
???: dito when testing firstpassword
???: dito om --interactive (better output)

------------------------------------------------------------
quota:

Reihenfolge:

1) apt install quota


2) Die Partition des share mit quota optionen mounten:
   Hierauf kommts an: jqfmt=vfsv0,usrjquota=aquota.user,grpjquota=aquota.group
   z.B. in /etc/fstab

   /dev/mapper/srv-default--school on \n
      /srv/samba/schools/default-school \n
      type ext4 (rw,relatime,errors=remount-ro,data=ordered,jqfmt=vfsv0,usrjquota=aquota.user,grpjquota=aquota.group)


   umount /srv/samba/schools/default-school
   mount -a

3) 
    quotacheck -cvua    (create verbose userquota all-filesystems)
    quotacheck -cvuga    (create verbose userquota groupquota all-filesystems)


    - davor evtl alte aquota.user löschen mit:
      lsattr /srv/samba/schools/default-school/aquota.user
      --> ----i--A-----e--   immutable bit gesetzt
      chattr /srv/samba/schools/default-school/aquota.user
      rm -rf /srv/samba/schools/default-school/aquota.user
      oder vorher
      quotaoff -a

4) Dafür sorgen dass auota.user/aquota.group upgedated werden:
   quotaon /srv/samba/schools/default-school

5)  Filesystemquota auf Linuxseite testen:

    repquota -au
    repquota -aus    (s=human readable)

    --> was muss man tun, damit usernamen aufgelöst werden ????

5) /usr/bin/smbcquotas -L //localhost/all -U administrator%'Muster!'

--> smbcquotas examples
    The smbcquotas program manipulates NT Quotas on SMB file shares.
    /usr/bin/smbcquotas -U administrator%Muster! //linuxmuster.local/bsz 




############ Achtung: das scheint nur zu tun, wenn das smb-share einer Partition entspricht
(aquota.user in )

Beispiel:
 net conf list
[all]
	path = /
	guest ok = yes
	read only = no
und 
/dev/mapper/xenialserver--vg-root on / type ext4 (rw,relatime,errors=remount-ro,data=ordered,jqfmt=vfsv0,usrjquota=aquota.user,grpjquota=aquota.group)
#############







Todo:

smbcacls,smbcquotas usw. command

sub execute_smbx_command($base_command,$part1,$part2,$smb_pass);
  $smb_pass is fitted between $part1 and $part2
-> centrally configurable sophomorix.ini
   SHOW_SMBX_COMMAND=TRUE/FALSE
   # command zeigen, ohne password bzw '******'
   SHOW_SMBX_COMMAND_PASSWORDS=TRUE/FALSE
   --> wichtig beim debuggen usw.

testen mit: 
&execute_smbx_command("SMBCQUOTAS",$debug_level,$smb_admin_pass,""," -L //$root_dns/$share"
sophomorix-quota --share all -F
sophomorix-quota --share all -L



Auf share setzen
OK: "strict allocate = yes"
Todo: --> document in source

bei 
sophomorix-quota --developer-setquota all:-4 -u maiersa42
gute Fehlermeldung anzeigen


Testen project-acls (Tests anpassen)

Nutzen von:
sophomorix-samba/config-devel/ntacl/examsession.ntacl.template

sollte man default quota setzen auf dem share für alle schüler?
haben die dann beim anlegen den default?

Quota doku zeichnen
sophomorixQuota beim user: <share>:<user_hardlimit>:<user_calculated>:<smb-quota-actually-set>

tools: fill up quota with mput (use kernel for example)


Also bräuchte man für eine 


smbcquotas -F //localhost/share

--> Quotas Enabled On

Flags:

Enabled
Deny Disk
Log Soft Limit
Log Hard Limit
(--> wohin wird geloggt?)

smbcquotas -L //localhost/share

Add a limit:
smbcquotas -S UQLIM:<user>:<num_hard_bytes>/num_soft_bytes //localhost/share

--> wird nicht exakt umgesetzt (zum nächsten Block im FS umgesetzt)

linux: repquota zeigt in 1k Blockgröße an (1024*kleiner als smbcquotas)

smbcquotas -S UQLIM:<user>:-1/-1 //localhost/share
--> No LIMIT
------------------------------------------------------------

############################################################

------------------------------------------------------------
sophomorix needs to run on the domain controller:
  - next uid/gid files
  - access to /var/lib/samba/private/sam.ldb (update unicodePwd)
------------------------------------------------------------

next developer meeting

sophomorix-exam-mode --unset --participants <user1>,<user2>,..
soll da noch der participant hinzu?
- um das wegnehmen des users aus einer ka zu erschweren?
------------------------------------------------------------

sophomorix-print:
können Daten, die mit --caller-copy kopiert wurden vom user gelesen werden?

richtig testbar erst nach Migration

List templates with help option?

Ersetzungen???:
   ADMINLIST
   URLSCHUKO
   URLMOODLE
   URLMAIL

?? Falls kein passendes paket-template in der richtigen sprache da ist, auf das Deutsche zurückgreifen?
oder Fehler ??

--project macht userliste (komplex da auch Gruppen mitglied sein können)

??? 
exam-mode nur bei bestimmten Status erlauben? Aktive user
???

sophomorix-session -i -s session:



AD_user_kill
   identifier unused in sub -> remove?
   mitloggen der genutzten samaccount namen?

sophomorix-passwd: password ändern mit option


austeilen/einsammeln-Befehle
------------------------------------------------------------
von unix auf smbshare mit: mput, recurse

optionen: sharename,unix-from-path

/usr/local/bin/smbclient //servername/share  -c "cd remote_path_of share; lcd /var/schuko/dir; prompt; recurse; mput *; exit;"

prompt: Nachfrage für jedes file an/aus (prompt=aus)
exit: beendet connection

exit evtl. vermeiden und mehrfach kopieren, spart Zeit?

von smbshare zu smbshare

  * server site copy nutzen:
    https://wiki.samba.org/index.php/Server-Side_Copy
  * gvfs
    http://manpages.ubuntu.com/manpages/trusty/man1/gvfs-copy.1.html
  * mount als smb share, use find usw, rsync
  sudo mount -t cifs //192.168.2.73/BACKUPS /mnt -o username=luis,file_mode=0777,dir_mode=0777

debuglevel von samba an smbclient, usw. durchreichen
default=0


sophomorix-admin -i
binduser: anzeigen von
- password
- loginname
- CN=global....... .lan  AD-pfad ausgeben


password hash cloning cloning
optional $ldap,root_dse
wenn undef, dann selber bindm,unbind


sernet-Pakete:
- Wichtig Rahmenbedingungen:
  - dauerhafte Lösung für linuxmuster.net ohne Nachforderungen
  - unbekannte Anzahl von schulen
  - eigenes Repo auf http://pkg.linuxmuster.net erforderlich, da Pakete zuerst getestet werden müssen,
    bevor sie an die Schulen verteilt werden können
- Kosten sind fürden  Verein möglich zu übernehmen, geringer Umfang
- verzögerte Pakete OK für linuxmuster.net, aber nicht bei:
   - sicherheitskritischen Dingen
   - selbst bezahlten features (smbcacls rekursiv)


------------------------------------------------------------
PROGRESS (Rückgabe bei langlaufenden Scripten)

--> STDERR
comment_en
step:
final_step
duration:
duration_time   (noch )

OK: sophomorix-add
    ---> beispielhaft

sophomorix-update
sophomorix-kill
sophomorix-device
sophomorix-exam-mode mit progress JSON output
    setting user ... in exam mode, unset
-> Textstrings in sophomorix.ini



------------------------------------------------------------
sophomorix-repair --school auf resettetem system mit vielen Fehlern

todo:
0) testen ob hash bei demselben password gleich ist
   -> password übertragbar?
1) school share: statt guest ok -> valid users = @LINUXMUSTER\acb  @LINUXMUSTER\global-admins
2) mv von homes
3) migration:
    * tausch syncen
      wie macht man ein Verzichnis read only auf einem share nur für die Gruppe?
    * migration_repair eines home
      - acl für dir?
      - acl für file?

------------------------------------------------------------
1. NTACL: vollständige Klärung, ob wir die Controlbits weglassen können
   Control bits ergeben sich durch setzen der ACL's
   Propagation der inheritance (muss propagiert werden)
   Windows-GUI macht das rekursiv, smbcacls kann das (noch) nicht

2. Die NTACLs unseres Schulservers durchgehen
   bisheriges home (schüler darf nur lesen und durch):
   work  -> Hier darf Schüler schreiben
   _einsammeln -> hier nicht
   _austeilen -> hier nicht
NEU: --> transfer


   --> wird noch recherchiert

   school-share:
      statt
        guest ok = yes
      Kommt
        valid users = administrator@LINUXMUSTER.LOCAL, @LINUXMUSTER\acb,  @LINUXMUSTER\global-admins, ...  (acb=schulgruppe)
                      oder acb@linuxmuster.lan
        -> workgroup= kurzer domänenname (kurze Domänename bzw. netbiosname)
	-> realm    = langer domänenname.lan  lange Domänename = dns-Zonen-name


TODO:

-> statt user administrator 
    user administrator mitglied der gruppe global-admins
    (statt valid users = administrator@LINUXMUSTER.LOCAL) 



OK: umgesetzt mit acb@LINUXMUSTER.LAN

   dfs
   Freigabe der schule mit msdfs proxy = \fileserver-bsz\abc
     -> msdfs proxy: EINZIGE OPTION die erfordelich ist (ohne msdfs root und andere)  
     -> alle anderen optionen werden ungültig (trotzdem drin lassen?)
     -> Optionen wie Comment usw. müssen auf Fileserver liegen, auf den msdfs proxy zeigt

3. sync von homes
   wie kommen migrierte Daten ins home
  (alt: undefinierter Zustand)
   1) migration:
     HOMES:
     1) irgendwie syncen ( z.B. rsync via ssh)
     2) ACL drüberbügeln
        - files und directories getrennt
     TAUSCH:
     - READ-Only in unterordner (Altes-Tauchverzeichnis-gelösch_ab_10_12_2017)
       - getrennt nach
          --sync-teachershare
          --sync-classshare
	  --sync-projectshare
   2) versetzen von einer zur anderen schule
      statt move via samba-shares
     


4. Zugriffe auf AD-Objekte Attribute regeln
   (Teilbaum, Attribute ausblenden, ...)

   geht
   von konsole aus nicht simple, aber scriptbar

   Lesezugriff auf Unterbaum
   --> liefert nach
   adsi editor

   samba version 4.3.11
   --> besser sernet-Version
   --> Distributionspakete updatebar
       ---> sernet repo eintragen, update, fertig
       
   ---> wird nachgeliefert:
        - wie zusammengeklicktes mit adsi abernten
        - kann sein, dass man aktuelleres samba braucht

   schema-Erweiterungen schützen
   Erstpasswörter:
   Geburtstag:
      nicht lesbar
   ---> wird nachgeliefert


5. Passwort Hash-Frage, Ob wir da richtig vorgehen (ungesaltete Passwörter)
   - testen, ob kopiertes passwort bei anderem Passwort

   - password history aktivieren (alte Passörter führen nicht zum sperren des Accounts)

   --> Info zu salt in den Passwort hashes wird nachgeliefert

------------------------------------------------------------
SophomorixTest.pm:

script starten mit parameterkombination, die zum abbruch führen soll
  BSP: sophomorix-admin --create-* ohne password option
  RESULT JSON anschauen und nach der passenden Fehlermeldung suchen

  &run_command_verify_exit("sophomorix-admin --create-global-binduser global-binduser-666 --password",
                           "ERROR: A password option is needed");
  -> eigentlich sollte das run_command machen

Weitere tests:

start_user_test
end_user_test
(dito mit group, oder zusammen als start_object_test)
-> mitloggen, welche user/gruppengetestet wurden
--> user/group exists, but not tested
------------------------------------------------------------

Problem:
sophomorix-repair erzeugt viele Fehler, wenn schulen konfiguriert,
  aber die Schule noch nicht angelegt ist
Mögliche Reaktion:
--sophomorix-repair erzeugt die Schulen (evtl. nicht gewollt)


sophomorix-check:
Warnungen:
ERROR:   Line seen multiple times: n
WARNING: User seen in multiple classes

Result hash:
sollte beinhalten:
x user mit fehlendem Geburtsdatum
x user mit unrealistischem Jahr im ...
x user mit unerlaubtem Zeichen im Nachnamen
x ... Vornamen


use lastname for Encoding detection

school.conf -> file
    CLASS_MAP=12=oberstufe12,13=oberstufe13


------------------------------------------------------------
scheduled freeze(z.B. Lehrer):
   - datumsangabe/Haltbarkeit eines accounts
   - ab dem Datum wird es disabled (samba 4 Funktion nutzen)
   - entweder nur warnen
     - problem: entfernen aus 
- oder besser ein kalender?


------------------------------------------------------------
sophomorix-admin:

Bindusers:

Gruppen, die den ldap-Baum lesen (schreiben) können werden mit der Schule angelegt:
   GROUP = @@SCHOOLPREFIX@@AD_RO_auth|roauth|OU=Management
   GROUP = global-AD_RO_auth|globalroauth|OU=Management
ODER
   Es sind die schulgruppen <schulname> bzw. SCHOOLS

sophomorix-admin legt dann user an, die in diesen Gruppen sind 


Option für zufallspasswort Anzeigen:
--randompasswd-display -> JSON (Objekt noch testen)


------------------------------------------------------------


optionen:

--password NICHT OK
--passwd   OK, bzw. beide möglich
in Doku nur eins von beiden: --passwd (kürzer)

------------------------------------------------------------


Bugs nach AK:

students.csv
doppelte Zeilen, andere Klassen

sophomorix-user:
-> funktionen die suchen dann noch sophomorix -user -s "del R"?


- apostroph testen in Namen O'Reilly und O`Reilly (backtick)
  -> in UTF8 drin, nicht im Loginnamen
     nicht in ascii? ist das richtig?


sophomorix-check
error_strg weiter
Klassencheck fertig
Datumscheck fertig
Vorname WARNING bei / ..... usw -> siehe ascii-Tabelle
nachname

login-creation: wenn nicht nur a-z rauskommt, warnung/error


Jahreszahl-Algorithmus Besser:
gültige Jahreszahlen werden je File berechnet:
min_age=6
max_age=40
geht von heutigen Jahr 6 Jahre zurück ... -6 ... -40
und erlaubt 2007,07,7 im hash

tests für students.csv.errors-*
-> Anzahl Zeilen in sophomorix.error


Handling doppelter Zeilen in students.csv


Wenn kein Sonderzeichen gefunden wurde, ASCII annehmen


bei using UTF usw. : surnames: 126, firstnames 4 (Anzahl der hits)


Wenn von linuxmuster-import-devices sophomorix-device aufgerufen wird
sollte irgendwann der Returnwert des json-Objekts verwendet werden

sophomorix user -i -u <login> ()
sophomorix-user -u (ohne weitere option -i sollte den user anzeigen)

sophomorix-user -s <string> sollte in vorname, vorname ascii .... suchen

doppelte Zeilen liefern Fehler


setup:

unattended hat Probleme

creating linbofs dauerte bei manchen sehr lange
-> Hinweis auf die dauer wäre be einigen ungeduldigen nicht schlecht (This can take a few minutes)
   oder bei zwischenschritten eine Ausgabe

nach ablauf der (unsichtbaren) Passwordeingabe wird das Password doch noch geechoed, wenn das script läuft.

Tippfehler bei Passwordeingabe: unvisible -> invisible

bei manchen Installationen (eigentlich identisch) wurde der global-admin nicht angelegt 
(hinterher anlegen, anlegen bei erneutem Setup war möglich)
Fehlermeldung von sophomorix-admin .... war No connection to AD
-> Laufzeitproblem? wird der admin zu früh angelegt?


import devices:

wir hatten server ip 10.0.0.1 255.255.0.0

Trotzdem wurden Rechner mit IP 10.170.10.241 angelegt
-> macht das Sinn?
-> sollte man nicht prüfen, ob die IP's der Rechner im Netz liegen



sophomorix-check -ij bricht ab bei syntaxfehler in bsz.school.conf
(userfile.students.csv)
aber sophomorix.add nicht (sollte auch abbrechen)



sophomorix-nochange soll sophomorix.nochange auflisten
sophomorix.nochange nicht mit admins???


Exam modus:


------------------------------------------------------------
sophomorix-exam-mode -i:
sinnvolles ordnen, evtl. session berücksich

--> sophomorix-exam-mode mit einem Aufruf mehrere benutzer in exam-mode setzbar

Exam: Jeder Schritt in sophomorix.ini konfigurierbar

WEITER:
smb_home bei den kill_funktionen in sub

user aus anderen Schule in exammode
andere examuser testen

sophomorix-user -i soll examuser anzeigen

homedir erstellen, ntacl

homedir testen


evtl. noch dazu:
[exammode]
	TESTLOCK=TRUE
	TESTOTHEREXAM=TRUE
	DISABLE_FIRST=TRUE
	LOGINAME=postfix
	CREATE_DISABLED=TRUE
	PASSWORD=random
	managementgroup = ......
	REMOVELOCK=TRUE
	DISABLE_LOGIN=TRUE
	ENABLE_LOGIN_EXAM=TRUE


KA-Modus in der Session starten
   -> Abruch:
      * einer der user ist schon im exam-mode
      * einer der zu erzeugenden accounts gibts schon
   (später-> session kopieren, neue benutzer definieren,
    sodass KA-session Wochen vorher vorbereitet werden kann)
Abfolge Zusatzaccount anlegen:
  * update <login>-Account
     * Nur wenn kein anderer schon exam mode nutzt
       # nicht mehr: Nur wenn noch nicht gelockt (von anderem)
       # nicht mehr: LOCK-supervisor-Date-Time in sophomorixExamMode bei <login>
     * (nicht mehr <login> disablen, doppelanmeldungen verhindern)
     * Zwangsabmeldung von <login>

  * neuer Account erstellen
    * Abbruch, wenn es nicht jeder user nicht im 
    * neue sub mit option (<login>) (performant ohne schulcheck/klassencheck usw.)
     * Loginname des Zusatzaccounts:
        * <login>-exam (unsere Wahl)
        - <login>-session-id
        - <login>-short-session-id + ka vorbereitbar
        - <rechnername>
     * disabled anlegen
     * Passwort:
        * am besten wie <login> -> testen ob das geht
        * ansonsten: Passwort setzen (muss komplex genug sein),
	      --password "Muster!"
     * AD-Ort: OU=Examuser(s) -> Anpassen
     * keine Gruppenmitgliedschaft
     * Home erstellen
        * srv/samba/schools/<school>/examuser(session-ide)
	* ohne Unterordner
        * spezielle ACL drüber (ähnlich Schüler)
        * kein Tausch
     * managementgruppen-Mitgliedschaften setzen
        * je nach Haken (zuerst alle leer?)
     * LOCK-supervisor-Date-Time in sophomorixExamMode bei <login> ersetzen
       mit finalem Inhalt
     * final step
       * disable <login>
       * enable <login>-exam


* Material teilen:


Während KA:
   * wer ist an welchem PC angemeldet
   * hinzukommende user haben schon einen Account, wenn sie in der session sind
     -> ansonsten nachmeldbar

Material holen (innerhalb der Schule rename):

   * srv/samba/schools/<school>/examuser(session-ide)
     worunter alle homes liegen ins home des Lehrers moven
     (owner erhalten oder ändern)

   * von userlisten nach supervisor
   * wie???

Abfolge Zusatzaccount entfernen:
   * Home löschen
   * Account <login>-exam löschen (oder aufbewahren)
   * Account <login> wieder enablen


sophomorix-examMode bei <login>-exam
------------------------------------------------------------
option --waitstep n seconds: um bei Tests schrittweise verfolgen zu können was passiert.

nach jedem Schritt n Sekunden warten




Abfolge:
  * Schuko Warnung, dass ausgeloggt wird, Anzeige wer eingeloggt
  * Prüfling zwangsausloggen(testen ob ausgeloggt)
  * Prüfling aus allen Gruppen austragen
    (wie ist das, wenn sein Klasse mitglied in einem Projekt ist?)
    --> konfigurierbar, welche das sind?
    --> Internetzugansg sperren?

--> AD-Eintrag, welcher Lehrer den user in exammode gesetzt hat (und Datum mit Uhrzeit?)

--> Heimatverzeichnis wegschieben 
    umbiegen nach .../KLASSE/USER-lock oder .../KLASSE/home/USER-lock ?
    in Heimatverzeichnis abspeichern: 
      - Gruppenzugehörigkeiten
      - Password-hash der momentanen Avccounts

--> neues, leeres Prüfungs-home anlegen (heißt wie altes, repdir.student_home benutzen)

Nach dem exam:
--> Examhome/einsammeln sichern zum lehrer, der exammodus *gestartet* hat
--> Examhome löschen
--> altes Heimatverzeichnis rück umbenennen
--> Gruppenzugehörigkeiten aus Datei herstellen (Datei dann löschen)
--> Password wiederherstellen (hashdatei löschen)

option: alle user aus exam-mode raus (cronjob bei Nacht)


sophomorix-session: managementgroup mit userliste (viele auf einmal setzen)
- soll auch als alle 2 sekunden cronjob laufen können, config nicht einlesen???

-- sophomorix-managementgroup modul --> ohne loggen, mehrfach paralles

-- exam-mode:
   * zuerst alle user locken string lock-<supervisor>-Datum ins sophomorixExamMode attribut
   * dann einen nach dem anderen in exam-mode eintragen 




Problem: zuerst Gruppen erzeugen, erst dann können NTACL's erzeugt werden:

in AD_school_create
&AD_create_school groups(SCHOOLS|$DevelConf::AD_global_ou)
wird 2x aufgerufen
-> besser: erstesmal ohne repdir
           zweitesmal mit repdir (noch besser nur repdir)

------------------------------------------------------------
NTACL umgesetzt

OK in repdir.school
/srv/samba/schools/default-school
/srv/samba/schools/default-school/students
/srv/samba/schools/default-school/management
/srv/samba/schools/default-school/projects

OK in repdir.teacherclass
/srv/samba/schools/default-school/teachers/
/srv/samba/schools/default-school/teachers/homes
/srv/samba/schools/default-school/teachers/share/

OK in repdir.teacher_home
/srv/samba/schools/default-school/teachers/homes/cv/

OK in repdir.adminclass
/srv/samba/schools/default-school/students/5a
/srv/samba/schools/default-school/students/5a/share
/srv/samba/schools/default-school/students/5a/homes

OK in repdir.student_home
/srv/samba/schools/default-school/students/5a/homes/adamskke/

OK in repdir.global
    /srv/samba/global/management
    /srv/samba/global/projects
    /srv/samba/global/teachers
    /srv/samba/global/students

OK in globaladministrator_home.ntacl.template
    /srv/samba/global/management/<global-admin>
OK in 
/srv/samba/schools/default-school/students/5a/homes/adamskke/_einsammeln
    /srv/samba/schools/default-school/management/<school-admin>

OK
/srv/samba/global
-> vorbereitet in global.ntacl.template

OK
/srv/samba/global/projects/<p_name>
-> in projects.share.ntacl.template



Noch Testen:

/srv/samba/schools/default-school/examusers
    examusers.ntacl  noch ersetzen
--> wie normale students klassen homes
sollte OK sein?

/srv/samba/schools/default-school/examusers/?exam?
    repdir.exam
    -> nutzt examusers.ntacl  
       ersetzen mit examsession.ntacl (entsprechend adminclass.ntacl)
-->     

/srv/samba/schools/default-school/examusers/?exam?/<examuser>
   repdir.examuser_home 
   OK: @@ADMINCLASS@@ -> @@SUBDIR@@
       examuser_home.ntacl sollte OK sein






Und unloeschbar:
/srv/samba/schools/default-school/students/5a/homes/adamskke/transfer
--> Unterschiedlich dazu
/srv/samba/schools/default-school/teachers/homes/cv/transfer
--> Unterschiedlich dazu
/srv/samba/schools/default-school/examusers/?exam?/transfer

Und evtl. dito für exam-user
------------------------------------------------------------


Testen:
smbcals -M OWNER:name
   Example: -M OWNER:'LINUXMUSTER\Domain Users' setzt den OWNER
smbcals -M GROUP:name
--> Wird aber auch schon mit der ACL-Datei gesetzt


CONTROL-Zeile im output von smbcacls wird noch nicht verarbeitet:

z.B, 
teacher_home.ntacl.template:    CONTROL:SR|DP
students.ntacl.template:        CONTROL:SR|PD|SI|DI|DP

Woher der Unterschied?
Wie wird das gestzt? Mit smbcacls?

-I remove   -> PD erscheint
-I allow|copy    -> PD verschwindet
see man smbcacls

how to set:
SI
DI
...

man smbcacls sagt unter anderem:

    --query-security-info FLAGS
           The security-info flags for queries.

       --set-security-info FLAGS
           The security-info flags for queries.



Die Control-Bits sind in source3/lib/util_sd.c erklärt:

 {SEC_DESC_OWNER_DEFAULTED,       "OD", "Owner Defaulted"},
 {SEC_DESC_GROUP_DEFAULTED,       "GD", "Group Defaulted"},
 {SEC_DESC_DACL_PRESENT,          "DP", "DACL Present"},
 {SEC_DESC_DACL_DEFAULTED,        "DD", "DACL Defaulted"},
 {SEC_DESC_SACL_PRESENT,          "SP", "SACL Present"},
 {SEC_DESC_SACL_DEFAULTED,        "SD", "SACL Defaulted"},
 {SEC_DESC_DACL_TRUSTED,          "DT", "DACL Trusted"},
 {SEC_DESC_SERVER_SECURITY,       "SS", "Server Security"},
 {SEC_DESC_DACL_AUTO_INHERIT_REQ, "DR", "DACL Inheritance Required"},
 {SEC_DESC_SACL_AUTO_INHERIT_REQ, "SR", "SACL Inheritance Required"},

 {SEC_DESC_DACL_AUTO_INHERITED,   "DI", "DACL Auto Inherited"},
 {SEC_DESC_SACL_AUTO_INHERITED,   "SI", "SACL Auto Inherited"},

 {SEC_DESC_DACL_PROTECTED,        "PD", "DACL Protected"},
 {SEC_DESC_SACL_PROTECTED,        "PS", "SACL Protected"},
 {SEC_DESC_RM_CONTROL_VALID,      "RM", "RM Control Valid"},
 {SEC_DESC_SELF_RELATIVE ,        "SR", "Self Relative"},

############################################################
sernet Problembeschreibung:

1) Auf dem Server sieht die Schule 'bsz' wie folgt aus:
# find /srv/samba/schools/bsz/

/srv/samba/schools/bsz/
/srv/samba/schools/bsz/teachers
/srv/samba/schools/bsz/teachers/share
/srv/samba/schools/bsz/teachers/homes
/srv/samba/schools/bsz/teachers/homes/oe42
/srv/samba/schools/bsz/teachers/homes/oe42/_einsammeln
/srv/samba/schools/bsz/teachers/homes/oe42/_austeilen
/srv/samba/schools/bsz/teachers/homes/wu42
/srv/samba/schools/bsz/teachers/homes/wu42/_einsammeln
/srv/samba/schools/bsz/teachers/homes/wu42/_austeilen
/srv/samba/schools/bsz/management
/srv/samba/schools/bsz/students
/srv/samba/schools/bsz/students/share
/srv/samba/schools/bsz/students/homes
/srv/samba/schools/bsz/students/m7ab
/srv/samba/schools/bsz/students/m7ab/share
/srv/samba/schools/bsz/students/m7ab/homes
/srv/samba/schools/bsz/students/m7ab/homes/maiersa42
/srv/samba/schools/bsz/students/m7ab/homes/maiersa42/_einsammeln
/srv/samba/schools/bsz/students/m7ab/homes/maiersa42/_austeilen
/srv/samba/schools/bsz/students/m7ab/homes/muellegr42
/srv/samba/schools/bsz/students/m7ab/homes/muellegr42/_einsammeln
/srv/samba/schools/bsz/students/m7ab/homes/muellegr42/_austeilen
/srv/samba/schools/bsz/students/m8cd
/srv/samba/schools/bsz/students/m8cd/share
/srv/samba/schools/bsz/students/m8cd/homes
/srv/samba/schools/bsz/students/m8cd/homes/samardze42
/srv/samba/schools/bsz/students/m8cd/homes/samardze42/_einsammeln
/srv/samba/schools/bsz/students/m8cd/homes/samardze42/_austeilen
/srv/samba/schools/bsz/students/m8cd/homes/jonsonad42
/srv/samba/schools/bsz/students/m8cd/homes/jonsonad42/_einsammeln
/srv/samba/schools/bsz/students/m8cd/homes/jonsonad42/_austeilen
/srv/samba/schools/bsz/projects

(m7ab,m8cd sind Schulklassen)

2) Jede Schule hat ihre eigene Freigabe, z.B. 'bsz'
# net conf list
[bsz]
	path = /srv/samba/schools/bsz
	comment = Share for school bsz
	guest ok = yes
	read only = no
	msdfs root = yes
	hide unreadable = yes

3) Wir haben uns per Windows-client/Explorer ACL's zusammengeklickt, Haken bei Vererbung,
   ... die nun per script umgesetzt werden sollen.

Die Verzeichnisse werden per script via SMB-Protokoll (smbclient) angelegt und mit smbcacls mit ACL's versehen

4) z.B. /srv/samba/schools/bsz/teachers SOLL so aussehen.

REVISION:1
CONTROL:SR|PD|SI|DI|DP
OWNER:BUILTIN\Administrators
GROUP:LINUXMUSTER\Domain Users
ACL:LINUXMUSTER\bsz-teachers:ALLOWED/0x0/READ
ACL:LINUXMUSTER\bsz-admins:ALLOWED/OI|CI/FULL

5) Gesetzt werden die ACL's im script so:

smbcacls -U administrator%'Muster!' //linuxmuster.local/bsz teachers --set 
  "REVISION:1,OWNER:BUILTIN\Administrators,GROUP:LINUXMUSTER\Domain Users,ACL:LINUXMUSTER\bsz-teachers:ALLOWED/0x0/READ,ACL:LINUXMUSTER\bsz-admins:ALLOWED/OI|CI/FULL"

6) Leider scheint smbcacls die CONTROL-Zeile nicht setzen zu können.

man smbcacls zeigt unter anderem:

    --query-security-info FLAGS
           The security-info flags for queries.

       --set-security-info FLAGS
           The security-info flags for queries.

Aber es wird nirgends erwähnt was als 'FLAGS' angegeben werden muss um SR|PD|SI|DI|DP zu setzen.
############################################################



sophomorix-repair für die 2 admintypen anpassen

------------------------------------------------------------
sophomorix-check:
  bei sophomorix.adds schon loginnamen erstellen (die es noch nicht gibt)
  -> besser möglich einzelne user anzulegen mit loginnamen als parameter
  -> sophomorix-add prüft nochmal ob loginname möglich, wenn nicht garnix machen

------------------------------------------------------------

json output konfigurierbar auf stderr oder stdout
-> checken auf server



sernet-Anfrage 1

smbstatus -b zeigt, wer eingeloggt ist
Wir bräuchten:
A) Test, ob ein bestimmter User eingeloggt ist.
 -> wie kann man das einfach ermitteln? ohne smbstatus -b zu parsen
B) wir kann man einen user per script zwangsweise ausloggen
   (Klassenarbeit -> homeverzeichnis tauschen gegen leeres Klassenarbeitshome)

sernet-Anfrage 2

Daten von einem share zum anderen verschieben
- recursiv
- acls sollen erhalten bleiben
idealerweise mit rsync via smb-protocol, scheint es nicht zu geben
oder kann man beides smb-mounten und dann rsync incl. ntacls-syncen 

sernet-Anfrage 3

user einschränken auf teil-AD-baum (school-admin)
binduser einschranken auf loginattribute (teil AD-Baum)



------------------------------------------------------------

Test von Gruppe SCHOOLS und Schulen in test 2-5

sophomorix-repair (fix admins)

sophomorix-device ???:
use settings from [devicefile.devices.csv]
--> nur noch aus Develconf::
$dns_node_prefix_string="SophomorixdnsNode";
$dns_zone_prefix_string="SophomorixdnsZone";
--> später nach sophomorix.ini umziehen:
[VARS]
#	DNS_NODE_PREFIX = "SophomorixdnsNode"    # Prefix for all DNS Nodes created by sophomorix
#	DNS_ZONE_PREFIX = "SophomorixdnsZone"    # Prefix for all DNS Zones created by sophomorix





sophomorix.ini ?????:
definitions in [OU] should be moved to other sections
i.e. AD_project_ou
should be moved to upcoming? section [type.project]->[SUB_OU]

principle: for each role/type and userfile/devicefile there is a section with defaults 


samba-tools Gruppen vermeiden:
1) eine Klasse soll angelegt werden
2a) check ob sie schon existiert
2b) check ob es eine sophomorix Klasse ist
3)
-> nichtexistent -> anlegen
-> existent und sophomorix Klasse -> OK, nix zu tun
-> existent aber keine sophomorix-klasse:
   A) klasse nicht anlegen, user nicht anlegen -> warnung
      Klasse wurde von Hand angelegt
      Lösung 1
      -> von Hand löschen, check, add
      Lösung 2
      -> Group map Eintrag
       (Umsetzung todo)




nextcloud:

mailattribut  -> einzel, mehrfach

Homeverzeichnis -> zum mounten
-> per smb:// ?


Kontakte in thunderbird: add-on Cardbook (ohne sogo connector)

App "External storage support"

mit vpn und darin smb

Standort: DMZ, Pinhole um smb:// homes zu erreichen

Nextcloud
Alle user das Home-share verbinden
server: 10.16.1.1
$user
Anmeldedaten in Sitzung speichern




Parameter in students.csv:
login_prefix=R17-         macht logins mit R17-nachnamevor[123]
login_classprefix=yes     macht Logins mit klasse-nachnamevor[123]


------------------------------------------------------------
Bug:
neuer parameter LOGINPREFIX in school.master.ini und überschreiben in
bsz.school.conf mit anderem Wert ändert diesen Wert nicht nur in bst.students.conf sondern auch an anderer Stelle
------------------------------------------------------------

Bug: wenn adminclass entfernt wird, bleibt die übergeordnete ou erhalten





attribut mail beim anlegen eines users füllen (single Value)
-> unveränderbar, da Datenschutzprobleme bei Minderjährigen, wenn sie ihre private Mail eingeben
-> evtl. als weiterleitung

weitere Attribute über eigenes attribut (multivalue)??





todo wie erkennt man remote shares?:
tauchen die in net config list auf?
    - wenn ja: OK
    - evtl. remote shares in sophomorix_config zu schreiben

weiter:

creating test-1 for migration users
see 
  sophomorix.add-1
  sophomorix-test-1





--------------------------------------------------
??? DomainDNS:
DC=LINUXMUSTER,DC=LOCAL
oder
DC=linuxmuster,DC=local
oder ist das egal???
--------------------------------------------------

--------------------------------------------------
CN=SCHOOLS,OU=SCHOOLS, ...
besser nach ????
OU=Groups,OU=GLOBAL, ...
zu globalen Projekten

Sollen auch global-students, global-teachers und global-admins in SCHOOLS?
---> wieder die Frage des Ortes, siehe 4 Zeilen höher
   
--------------------------------------------------


--------------------------------------------------
Übergang:
----------
sophomorix.ini ZUSÄTZLICH lesen

Einige Parameter aus sophomorix-devel.conf
in die sophomorix.ini umlagern

- laden der sophomorix.ini in sophomorix_config->DEVELCONF

-> sophomorix-devel.conf abschaffen? teilweise ja, aber hashes dort behalten?

lesen der School. ini:

trailing whitespace abschneiden


sophomorix.ini für Pfade:

[PATH]
	CONF_SOPHOMORIX=/etc/linuxmuster/sophomorix
	CONF_TMP=/var/lib/sophomorix/tmp

[NAME]
	DEFAULT_SCHOOL=default-school

[ENCODING]
	FIRSTNAMES=firstnames.UTF8.txt,firstnames.ISO_8859-1.txt
	FIRSTNAME_ERRORS=firstname_errors.UTF8.txt,firstname_errors.ISO_8859-1.txt
...



----------
Final
sophomorix-devel.conf
UND
sophomorix-Roletype.conf
in einer datei
sophomorix.ini
--------------------------------------------------


--------------------------------------------------
Create result hash VOR sophomorix_config
OK use JSON
OK option -j+
OK %sophomorix_result=&result_sophomorix_init("scriptname", ...);
   ... initialisiert einen result hash

OK &result_sophomorix_add(\%sophomorix_result,"ERROR|WARNING",$err_num,$string);
   ... schreibt ERROR|WARNING in den result hash

OK &result_sophomorix_add_summary({
                     NAME=>"NOCHANGE", 
                     RESULT=>$lc_nochange, 
                     RESULT_TYPE => "integer",
                     DESCRIPTION_POST => "users are not to be changed in ".basename($nochange_file), 
                     DESCRIPTION_PRE => "users in ".basename($nochange_file), 
                     FORMAT_TYPE => 1,
                     sophomorix_result=>\%sophomorix_result,
			       });
   ... schreibt ein Resultat mit beliebigem Namen

OK &result_sophomorix_add_log(\%sophomorix_result,$string);
   ... loggt etwas in den result hash

OK &result_sophomorix_check_exit(\%sophomorix_result);
   ... checks if WARN/ERR were so severe (misconfigured) that the script should exit, and exits
   ... called before something ist changed
   ... display EXIT Error  

OK &result_sophomorix_print(\%sophomorix_result,$json);
   ... called at the end of the script
   ... prints JSON with option --JSON
   ... prints on Terminal iithout --JSON

--------------------------------------------------
desccription field
  - of a user ist chageable by the admin
  - of a group ist chageable by the admin
--> it is not updated
??? check if this is true ???


??? add logging to tests ??? 
so we ca see in commnd log, which commands were execuded by wich test

Configs:

replacing all {PARAMETER} with {'PARAMETER'} ???
make all parameters lowercase

count number of hits ???
when checking config against master:
if hits are below 10%, exit with error: seems strange
read master returns count of parameters

Was tun wenn die samba server passwortlänge sich mit den 
Einstellungen der USER_FILES beißt 



encoding und encoding force
Nochmal überlegen, welche Fälle auftreten können

ENCODING=auto: sophomorix ermitelt

ENCODIG = UTF8
FORCE=no
--> UTF8 annehmen, evtl. ändern? oder warnen?
ENCODIG = UTF8
FORCE=yes
--> Umcodierung nach UTF8 forcen, egal was kommt




what to do if configuration is bad: warn or exit?


test-1:

add configs? or remove them from git


weiter:

sophomorix-check:

# ???? what to do here
  todo: login creation in sophomorix-add
        login in 5th field teachers.csv OK
        testing random password creation
JETZT:
students: Feld 5 wird als unid gesehen:
   - upload bei exact matches (ALLES außer unid gleich, auch Klasse,Schule)

unid double problem:
   what if unid is double in different files?
   this cant be avoided
   ---> upload filename.unid to AD attribute unid?
        ohne unid --- nach sophomorixUnid
   ---> bei schulwechsel eines schülers: neue unid (wäre ohne filename auch so)
                                    ---> neuer Account
        ist das OK so?
   ---> zusammenführen der accounts per script???

Options to be added ????:
--dummy-bithdate (also konfigurable), use 01.01.1970 as birthdate
  for all users
--skip unids 
  (ignore the unids in files, do not upload)
--upload unids (upload unids for exacr matches, this might be default)


sophomorix-test-workflow
 - add more projects
   - make projects member of project

test: sophomorix-test-workflow
   test wenn user leicht verändert wieder kommt 

Testing: test with users that would create the same loginname
         (differ only in birthdate and class)


test script: suche nach user fragmenten|gruppen fragmenten im AD
   - wo ist der user xyz42 noch in einem attribut


neues attribut: sophomorixLockingDateEnd
sophomorix-check/update ativiert den user wieder zu status A
   sophomorix-user -u user -L --days <day-num>
neues Attribut????:
        sophomorixFullAdminClass
        --> bsz-m3kk3t
        (sophomorixAdminClass --> m3kk3t)


sophomorix-user -i
   --> Übersicht zeigen, wie bisher
-i -K
   --> alle killable zeigen (einer pro Zeile)

-i -K -v
   --> alle zeigen, wichtige Attribute

-i -K -vv 
   --> alle zeigen, dump der Net::LDAP abfrage

ebenso mit -u user
           -s searchstring

Status wechseln 
  R und K??? wie wars
  E und a tauschen hat Vorteil:
   automatismus: deacrivated and activated
   von hand: enabled
--> statuskorrektur bei migration erforderlich???
    ??? Option repair status bei sophomori-check ???


script sophomorix-nochange to show sophomorix.nochange ???

sophomorix-workflow: .nochange
  - die user die T und D sind und sich der status nicht ändert auch nach nochange?

######
überlegen: funktionen 
&get_all roles  (all user roles)
&get_all_types  (all group types)

return as search filters, commaseparated, ....
######

Dateisystem:
/home/  -> /srv/samba
/srv/samba/schools/bsz
/srv/samba/global

ext4 nehmen wegen quota
vor Umsetzung nochmals nachhaken




Next:

- sophomorix-device
  -  comment zur zone hinzufügen                                     OK
    -> testen ob zone und comment da                                 OK
  - nur die Zonen löschen die den comment haben                      todo
  - keine Zonen Doppelt anlegen  (unique list sub nutzen)
  - -i name:                                                         todo
  Alle Info zum device:
  - $Account
  - dnsnode
  - dnszone
  - mehr? linbo?

- test2:
  - nslookup reverse test                                             OK.
  - AD entry test für reverse lookup                                  OK.
  - Am Ende (devices entfernt)
    - alle dnsNode incl. reverse weg?                                 OK. 
    - alle dnsZone weg?                                               OK.

angleichen variablennamen: $dnszone, $dns_zone
                           $dnsnode, $dns_node


test1: test all options and flows of user account status changes      OK: 


############################################################
Konfigurationsdateien, ini smb
school.conf default Datei erstellen
  - festlegen der zulässigen Parameter
  - festlegen der default-werte
  - festlegen der erlaubten Werte
  --> z.B. yes|no   yes=default, no auch möglich
  --> z.B. 6|5|4|7|8|9|10|11|12|13
      bei der Länge der loginnamen
  --> Linuxmuster-Schule|String="A-Za-z0-9-_<space>"
  Ziel
  --> webui zeigt (evtl translated):
      --drop-down menü yes/no oder 5 bis 13
      --bzw. Infobox mit erlaubten Zeichen:
        A-Z
        a-z
        0-9
        - (Bindestrich)
        _ (underscore)
        <space> bzw. <Leerzeichen>

Ablauf beim lesen der Konfiguration:
- für jede Schule:
  - default-lesen (option: no-check)
    und in %sophomorix_config rein 
  - config der Schule lesen (option: check)
    - parameter einzeln durchgehen
      - wenn es den Parameternamen schon gibt (von default)
        dann überschreiben
      - wenn es den Namen nicht gibt, 
        Fehler, unzulässiger Parameter
  - evtl. checken, welche Parameter NICHT in school.conf sind:
    ausgeben, als unused features ausgeben

Neue Parameter definieren:
  1) Eintragen in default.conf
  2) Dann ist der Parameter möglich 

Frage: beim setup(Later): Entwicklertreffen
 - A) vereinfachte config kopieren? (Grundschule, Gymnasium, ... zu Wahl)?
 - B) volle config kopieren? für 
Default-config durch schulkonsole wählbar?

############################################################




sophomorix-check, .add , .kill workflow
DNS reverse lookups

Zone anlegen: samba-tool dns zonecreate localhost 100.16.10.in-addr.arpa --password='Muster!' -U administrator
samba-tool dns zonedelete <Your-AD-DNS-Server-IP-or-hostname> 0.99.10.in-addr.arpa --password='Muster!' -U administrator


Host anlegen: samba-tool dns add localhost 100.16.10.in-addr.arpa 1 PTR r100-pc01.linuxmuster.local --password='Muster!' -U administrator
dns delete <Your-AD-DNS-Server-IP-or-hostname> samdom.example.com demo A 10.99.0.55


samba-tool dns zonedelete linuxmuster.local 210.171.10.in-addr.arpa --password='Muster!' -U sophomorix-admin

samba-tool dns zonedelete localhost 2.170.10.in-addr.arpa --password='Muster!' -U administrator


dnsnodes wollen immer angelegt werden



ntacl_test

Later:
############################################################
* console printout made nicely
  _console_print_sessions
  ...
* sophomorix-school -i (show important data: admins?admin-mail?)
* sophomorix-admin: sort admins alphabetically, return json
* schoolname: a-z and 0-9 only, maximum length (regex configurable?)
* hwk groups in sophomorix-device
* man pages
* sophomorixAdminClass 
  - used by rooms, classes, ... better name: 
      sophomorixGroup            the group name
      sophomorixExitGroup        the group name before moved to attic
      sophomorixGroupBasename    the name in students.csv, ... no schooltoken
* AD_get_AD erzeugt listen. 
  Diese sollten noch per Schleife asciibetisch sortiert werden
* AD_get_AD liefert listen für ALLE sophomorixType (ouclass, usw ...) 
* Festplattenquota
* ACL_set_file in SophomorixBase.pm
  get LINUXMUSTER workgroup and others from smb.conf 
* sophomorix-managemengroup -i
  display all managemengroups nicely
* when creating an object (project, user, admin) always check beforehand if it already exists
  if it exist: exit without doing anything
  (see example code in sophomorix-admin --create <name is checked>)
* AD_get_AD:
  management=TRUE -> schleife statt 6 einzelne suchen
* Klassen per cronjob ntfernen, in denen
  A) kein user drin ist
  B) 450 Tage keine Änderung war
  Umsetzung: getested mit global-internet
    sobald ein user in eine Gruppe kommt wird im 
    attribut 'whenChanged' die Zeit aktualisiert
       -> Anzeigbar machen (Projekt zuletzt aktualisiert,
           ....)
       -> bei nichtbenutzten adminclasses sollte also 
          'whenChanged' gleich bleiben
* possible Feature:
  - Händisches vorabanlegen/selbstanlegen der user (Schulkonsole), mit spezial-Kommentar in 
    sophomorixAdminFile (Vorname,Nachname,Gebdat,schule)
  - Falls derselbe user dann in einer Schuldatei auftaucht wird integriert/zusammengefpührt
    (sophomorixAdminFile, ...)
* Referenzen statt Kopien großer hashes:
  Beispiel: sophomorix-check
            my %AD= %$ref_AD; 
            Ist diese Kopie notwendig?
            Suchen, ob weitere Kopien gibt wo Referenzen möglich wären
* sophomorix-user
  in allen optionen kommasepatierte userlisten zulassen
  user_count und max_user_count nutzen im PROGRESS Objekt
* code cleanup: surname mit lastname ersetzen
############################################################




Überlegen:
############################################################
sophomorixAdminClass: 
  - bisher Klassenname MIT Prefix. 
  - Besser ohne prefix? Was äbdert sich dann?
  - oder neues Attribut sophomorixAdminClassBasename? Exit.... auch?
############################################################




todo:
############################################################
sophomorix-sessions  comments:                         OK 16.1.2017
manpage sophomorix-session:                            OK 16.1.2017
add the groups 
  webfilter
  intranet
  printing                                             OK 16.1.2017
Update tests for new memberships                       OK 17.1.2017

display membership status with sophomorix-session -ij  OK 17.1.2017

sophomorix-managemengroup to add/remove users simply   OK 17.1.17

tests for sophomorix-managemengroup
all options, add, remove single user multiple user     OK 18.1.17
add and remove in one line combined                    OK 18.1.17

DN: OU=global,OU=SCHOOLS,DC=linuxmuster,DC=local
 entsteht bei tests irtümlicherweise
-->nonexisting test, Bugfixed                          OK 18.1.2017

Bei Listen 1er Session mit:
sophomorix-session -ij --session 2017-01-22_18-03-16
- wird beim supervisor dessen collect angezeigt        OK 22.1.17
- wird beim supervisor dessen share angezeigt          OK 22.1.17
(dummy listen)

Quota listen                                           OK 24.1.17
- wir nur bei participants angezeigt

Workflow                                               OK 2.2.17

sophomorix-admin
--create <adminname> --school global
Und beim setup:
sophomorix-admin --create global-admin --school global --password 'fdrTfdtt!i'
(kommt in Gruppe global-admins)
(Gruppe global-admins kommt in  "Domain Admins")

Andere Schule
sophomorix-admin --create <admin-name> --school bsz --password 'fdrTfdtt!i'
(kommt in Gruppe bsz-admins)
(Gruppe global-admins kommt in  "Domain Admins")
                                                      OK 3.2.17

----------------------------------------------------------------

Fileserver:

* Angeraten: Domain Controller und Fileserver auf verschiedenen Maschinen
  * Fileserver des DC_ für group policies, netlogon, sysvol
  * DC braucht signing/Fileserver nicht-> Performance unterschied
  * update notwendigkeit verschieden
  * sophomorix würde auf dem Domain Controller laufen
* ALLES über smb erledigen (kein NFS, ... auf dieselben Daten)
  * Linux: aktuelle cifs-clients sehr gut
* Backup MIT acl's: z.B. rsync MIT extended Atributes
* Dateisystem
  * ext4 (konservativ)
  * xfs (neuste funktionen nur in aktuelleren Kerneln, nicht in LTS 16.04)
  * btrfs (lvm nicht mehr notwndig, Samba VSS Modul vorhanden, CopyOnWrite uvw., in LTS 16.04 enthalten)
* ACL's
  * win ACL's und posix ACL's sind was verschiedenes
  * defaultmäßig setzt smbcacls BEIDES
  * setzen von posix ACL's ist abschaltbar pro share
    * vfs objects = acl_xattr
        stored in the Extended Attribute security.NTACL
    * zeigen: 
       getfattr -d filename (reicht nicht)
       getfattr -n security.NTACL filename
* DFS: spricht nichts dagegen
  * 3 Typen:
    * Filesystem/Links pro Ordner (besser getestet)
    * Filesystem/Links in AD (nicht so getestet)
    * DFS Proxy (pro share) 

* user "Administrator" 
  * ist nur in AD
    * wbinfo -u   zeigt: 
         LINUXMUSTER\sophomorix-admin
         LINUXMUSTER\administrator
    * wbinfo -i administrator / wbinfo -i Administrator
    LINUXMUSTER\administrator:*:0:100::/home/LINUXMUSTER/administrator:/bin/false
    LINUXMUSTER\sophomorix-admin:*:3000017:100::/home/LINUXMUSTER/sophomorix-admin:/bin/false
* Tools:
  * smbcacls
  * smbcquotas
  * smbclient
  * kann man mkdir, chmod, .... auf dem samba share abschalten???
* Setup:
  1) DC einrichten
  2) Fileserver einrichten
  3) net ads join (Benutzer und Kennwort des DC)
  4) Freigaben auf dem Fileserver + DFS Eintrag auf dem DC

* Fragen:
  
Welcher user nutzt smbclient und smbcals?
Bisher: Admministrator (sonst tuts nicht) da id=0
AD_bind sollte derselbe user sein also 
entweder sophomorix-admin oder Administrator
Hier noch anpassen:
   -->  SophomorixBase.pm: my $smbcacls_base_command="



sophomorix-repair 
------------------------------------------------------------
sophomorix-repair und directoty tree:
dependencies

- make sure every school can be reached by a UNC path with  share
  (this should be done by school)
Administrator kann nur die verzeichnise anlegen?

smbcacls mit --kerberos nutzen
(Performance Vorteile mit kernberos ticket?)




Löschen von Verzeichnissen/Daten (rekursiv)
--------------------------------------------------------------------------------
- User: Home löschen beim entfernen des Accounts:            OK 
- Klassen NICHT löschen, wenn letzter User gelöscht wird     OK
  - Klassen können vorübergehend leer sein: nicht löschen    OK
- sophomorix-class -kill: tausch löschen                     OK
- projekt löschen: tauschverzeichnis löschen                 OK 

Feature or not?
sophomorix-user
Händisches vorabanlegen der user (Schulkonsole), mit spezial-Kommentar in sophomorixAdminFile
(Vorname,Nachname,Gebdat,schule)
Falls derselbe user dann in einer Schuldatei auftaucht wird integriert/zusammengefpührt
(sophomorixAdminFile, ...)


<bug>
tests für adminclasses: mittesten von 
sophomorixMembers
sophomorixAdmins
projects:
zusätzlich bei Projekten:
sophomorixMembergroups
sophomorixAdmingroups
Bug: werden nicht geleert beim löschen der user
--> löschen nicht mit samba-tool
</bug>

??? warum kann sophomorix-minitest get_homedirectory aufgerufen erdenwenn es in SophomorixBase nicht exportiert wird?
mit get_sharedirectory geht das nicht


<bug>
inconsistent:
sophomorix-class --create --class 7a
sophomorix-class --kill --class 7a
sophomorix-class --kill --class 7a

Einheitlich

</bug>

###??????????????????????????????????????????????????###

------------------------------------------------------------
sophomorix-exam: setzt user in KA-modus/oder nicht
   entsprechend wie managementgroups
      on user1,user2,...
Klassenarbeitsmodus setzen raus aus session, rein in sophomorix-exam???

------------------------------------------------------------
Nach provisioning durch linusmuster-base:
sophomorix-devel.conf:
  - user mit dem sophomorix arbeiten soll definieren
    -> sophomorix-admin
  - file angeben in dem das Passwort des users steht
    /etc/linuxmuster/.secret/sophomorix-admin



Managementgroups
------------------------------------------------------------
Beliebige managemengruppen erlauben/nachliefern können, z.B. nextcloud 
1) In Schule managementgruppe bereitstellen
  - bei AD_school_create hinzu
    sophomorix-school --create school <school>  (oder --update)
    sophomorix-school --create-all-schools     (todo, bei Paketinstallation)
2) Managementgruppen auf default zurücksetzen:
   Konfiguration in school.conf 
   (ini format, subsections mit '.' getrennt, konfigurierbar)

   Oder besser im AD konfigurierbar machen?
   (neue Attribute erforderlich)

   school.conf: Konfiguriere den Default der memberships
   [group.wifi] # jede Managementgruppe (evtl. später projekte)
     allow_group=12a,12b,teachers # students
     allow_users=maierle,muellerle
     except_users=lucifer   # lucifer ist in 12a
     except_group=5a  # falls group=students
     revert_allow_users=maierle,muellerle
     revert_allow_group=12a,12b,teachers # students
     revert_except_users=lucifer   # lucifer ist in 12a
     revert_except_group=5a  # falls group=students
     revert_cron=...  # Zeile für cronjob
     # allow:  nur diese user können vom Lehrer hinzugenommen werden
     # revert: rückstellen auf diesen default
   -> wifiaccess hat eigentlich 3 Stati:
      - vom admin erlaubt oder verboten
      - vom lehrer freischaltbar
      - default on/off (anlegen, nach KAs, ...)

  sophomorix-managementgroup --revert         -> zurück auf default
  sophomorix-managementgroup --revert-allow   -> alle möglichen


Rollen/Typen:

soll unterschieden werden???:

type=project          project einer Schule
type=globalproject    schulübergreigendes Project





common filter:
------------------------------------------------------------
weiter:
comment_line(column_nr,string)  kommentiert aus
drop_line(column_nr,string)  entfernt
bei string auch regex?

Diesen Filter in school.conf konfigurierbar machen:
DROP_LINE=6,String
(nach ini-Umstellung)


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
session beenden: 
was passiert dann mit den session einstellungen
(option reset?)



Fertig


Sollen user in global vorgesehen werden?
(außer global admins?)


Filesys-SmbClient
------------------------------------------------------------
perl smbmodul nimmt als workgroup WORKGROUP an.
workgroup ist aber LINUXMUSTER, bzw. das beim provisionieren angegebene
-> Probleme?


BUGS:
----------------------------------------------------------------------
<bug>

sophomorix-test-5:

sophomorix-admin --create admin-66 --school default-school --password 'Muster!'

legt an:

/home/schools/default-school/teachers
/home/schools/default-school/teachers/share
/home/schools/default-school/teachers/homes

sollte aber nicht

</bug>

Name "Conf::reverse_loginname_creation" used only once: possible typo at /usr/sbin/sophomorix-add line 367.



------------------------------------------------------------
sophomorix-device:

AD: je Drucker eine Gruppe
Wenn Drucker, dann Gruppe erstellen
    (Jeder nur-IP-Gerät(0 in Feld 11) bekommt eine Gruppe, 
     später konfigurierbar in devices.csv)
   User in Druckergruppe:  kann drucken
   Nicht in Druckergruppe: kann nicht drucken
   pyquota: Frank testet early ob AD attribute gebraucht werden

type of a room/roomws: wenn room wegfällt, wegen examaccounts, 
                       kann room für die workstations genommen werden (statt sophomorixType=roomws)





------------------------------------------------------------
AD_group_addmember_management

-> allow only adding in:
   -> a management group (no other type of group)
      
   -> of the same school as the user (as found out by sophomorixSchool)
      (choose the correct group) groupname in option: internet leads to group bsz-internet (if user is )
      options:
        --internet  <user1,user2>   --nointernet  <user1,user2>
        --wifi      <user1,user2>   --nowifi  <user1,user2>
        --intranet  <user1,user2>   --nointranet  <user1,user2> 
        --webfilter <user1,user2>   --nowebfilter <user1,user2> 
        --printing  <user1,user2>   --noprinting  <user1,user2>
        --admin     <user1,user2>   --noadmin <user1,user2>

 
   -> and beeing allowed to be added




sophomorix-session -i:

liefert dann noch folgende Infos:
     group_internetaccess_allowed  TRUE/FALSE
     group_internetaccess_default  TRUE/FALSE
     .... um in der Schulkonsole
       -- auf default zurückgehen zu können
       -- um einschalten ausgrauen zu können


------------------------------------------------------------
tests für status


------------------------------------------------------------
SophomorixSamba_AD:  suche nach: future groups in students.csv
dort sollten die zukünftigen Gruppen ermittelt werden, um vergave von loginnamen zu 
beschränken

------------------------------------------------------------
ouclass umbenennen in studentsclass oder students
-> muss in SophomorixSamba ersetzt werden
-> muss in sophomorix.ini ersetzt werden
-> und in Tests


???????????????????????
AD_get_container ersetzen mit config einstellungen

gibt 3x in SophomorixSamba:
   bei AD_computer_create: Role, room_basename

   bei AD_user_create:     Role, group_basename
       AD_group_create:    Type, group_basename



???????????????????????



xls input:
------------------------------------------------------------
viele Schulen bekommen xls Dateien aus der Schulverwaltung
für diese filter bereitstellen

Filter evtl. automatisch ermitteln lassen:

alle integrierten Filter durchgehen:
danach entstandene datei checken:

Erfolgreicher Filter führt zu einer folgenden Datei:

Klassenfeld: klassen, die sich wiederholen
Vorname: Namen aus Liste
Nachnamen: Namen aus Liste
Geburtsdatum: syntax, Ziffern
unid: muss eindeutig sein

-> Zusatzfelder werden an der selben Stelle im csv angehängt
-> ermittelter Filter sich merken
   -> nächstesmal als erstes checken 

------------------------------------------------------------
school (ehemals school_token,ou) usw
- Config hash,directories:
  school is used für this name
  if a name,dir,.. is needed for the default-school ist is 
  the contents of $DevelConf::name_default_school

In the AD the school token of the default school is ---



sophomorix-repair
------------------------------------------------------------

acl_test in sophomorix-developer
   -> dasselbe für ntacl_test

find test: 
1) testen obs ntacls gibt, abs-pfade sich meken
2) ntacl_test
3) testen ob alle ntacls getestet wurden

-> jede Zeile wird einzeln mit Test verglichen, um zu sehen WAS nicht passt
-> vorhandene Zeile und getestete Zeilen werden gezählt 
   test für gleiche Anzahl
-> getesteter Pfad wir in hash %acl_test_paths gespeichert, falls er mit /home beginnt

Zusatzbefehl:
&acl_are_all_tested();
  - macht ein find über /home/schools und /home/global (nur dirs?) und schaut:
    -> gibts nicht getestete dirs unter /home ? -> angangs evtl. ignorieren
       ---> schauen, ob Müll entstanden ist
  - für jedes gefundene dir in /home einen test:
    ->wurde es getestet
       -> ja, ok. Nein not ok       



User auflisten lassen,
dann  mit $root_dns,$school,$group_basename,$user,$role 
bzw. in unixHomeDirectory schauen
-> dann role-basiert die entsprechende ACL aufrufen





Weiter DNS: 

Datei mit anzulegenden zonen
  -> diese datei wird von linuxmuster-base erzeugt??
  -> Nur 1 Zone?
nicht mehrgenutzte Zonen löschen (geht das, wenn noch einträge da sind??)
Dann die DNS Nodes für reverse lookup zur passenden Zone hinzunehmen

------------------------------------------------------------
Hardwareclasses (hwk, hardwareklasse)
- in anzulegendes attribut sophomorixHardwareClass speichern, bei computer 
  (dnsnodes (ohne computzeraccount ) werden nicht gespeichert)
- UND: wird von sophomorix-device als Gruppenmitgliedschaft des Computeraccounts
  gespeichert
Umsetzung:
sophomorix-device
   - liest alle erforderlicen hwk aus files (und deren members)
   - liest vorhandene hwk aus AD (gruppen mit sophomorixTxpe hardwareclass)
   - abgleich
     nichtexistente hwk anlegen
     welche Computer in welcher hwk dazu
     welche computer aus welcher hwk raus
     nicht mehr benötigte hwk entfernen
---> nicht so dringend, beliebig nachlieferbar
------------------------------------------------------------

muss mac-adresse ins AD, wohin?
Kommentar ins AD, wohin?
--> weitere?


avoid deleting a computer twice remember killed, added, ... computers, dnsrecord
funktion, um Liste von doppelten einträgen zu befreien, dann sortieren

rename: workstation -> computer

save dnsZone by each dnsNode when reading into %AD hash : ist that so?

2,3, mehrere nic für einen computer, geht das?


check Dateinamen in *.school.conf:
USER:FILE: nur aus sophomorix.ini
CLASS_FILE: alle Namen zulässig
DEVICE_FILE: alle Namen zulässig

Klassenarbeit (exam)
- (neues Feld im ldap: DONE)
  -sophomorixExamMode: Inhalt loginame der lehrers, der ihn in KA versetzt hat
  oder --- Done
- zu tun wenn KA gestartet wird:
  sophomorix-teacher --examuser user1,user2,... --teacher bz
   macht: 
   A) sophomorixExamMode=bz
   B) PWDhash wegsichern (JSON-Objekt)
   C) Gruppen, in denen user direkt drin ist: sichern (gleiches JSON Objekt)
      (class, projekt1,projekt2) entfernen
      Damit wird auch Internet gesperrt
      (da user aus Internetgruppe herausfällt)
   D) JSON Objekt wegsichern ins tatsächliches home  
   E) home wegmoven  bz --> <bz-exam-backup>
      neues leeres home erzeugen: mkdir bz
   F) evtl. user nachträglich wieder in die 
      Gruppe internet für den Internet-Zugang

   G) nach der Anmeldung passwort auf Zufallspasswort setzen
   ????? wie findet man heraus welcher user an welchem PC angemeldet ist
   --> LDAP auslesen ? geht das? smbstatus -B



Bugs sophomorix-device

- variablen umbenennen
  workstation: begriff vermeiden

- unused rooms löschen
- unused zones löschen
- adminDescription und sophomorixAdminFile nutzen bei workstations, computeraccounts$
 



Geräteverwaltung:
Wie kommen Ducker in Cups
- wie bisher: web-gui von cups verwenden, einzeln anlegen
Rechner, Drucker, Access Points:
- lehrernetz/schuelernetz 
- ist eine Role erforderlich?
- wo im ldap? dns-admin-description



Liste zulässiger Dateinamen/Optionen abprüfen beim einlesen der Konfigurationsdateien


Wenn eine Gruppe gekillt wird, dann auch deren leeren OU container killen:
AD_group_kill

Anzahl dns zonen:

nur sophomorix? mit default zone? -> checken



sophomorix-dump-paket:
wenn virusscan nicht installiert, dann nicht dumpen

parameter in migration.conf may bzw. must auswerten
-> may: kein Fehler, bzw nur warnung



AD_get_name_tokened wird ersetzt durch sophomorix_config hash abfrage



remove_whitespace überall einsetzten

Passwoort falsch in sophomorix-samba.secret
--> Abbruch mit aussagekräftiger Fehlermeldung.


Passwortänderung erzwingen, wie geht das?
sollte auf gruppen , ... anwendbar sein.

Option --password (sophomorix-device , samba-tool) im printout entfernen

Projekte:
ldap-Feld: keep members on move (TRUE/FALSE)
Benutzer im Projekt lassen beim versetzen oder nicht
R. Schajor

ldap-Feld Bild für den user vorsehen?

SophomorixComment auch für Gruppen?
script sophomorix-comment im alle abweichenden Kommentare zu sehen?

sophomorix.add, ...
testen was ist wenn die Dateien nicht konfiguriert sind,
aber user auftreten: einfach zeile ignorieren


Neues Attribut im ldap:
OK: sophomorixAdminFile students.csv, abc.students.csv, ...
    ? updaten, wenn user in anderem File auftaucht? -> Ja

Kommentarfeld zu einem User:

sophomorix tests: SophomorixAdminFile checken

OK: sophomorixComment
OK: default: "created by sophomorix"
--> Wieviel Platz hat man in so einem Feld?
--> sophomorix user --show comments:
    Zeigt alle (non default) Kommentare

Bugs after moving to xenial
- membeships of the default groups are not correct
   --> add tests

- migration:
first test if 
remove group teachers first in classes.sh if existing
then recreate it with uid=10000
or: add gobal and  

what about /etc/linuxmuster/sophomorix/device/classrooms
--> classrooms.csv (more configuration stuff)
wegfallen lassen -> Daten in ldap?
   statt room ist group type classroom?






gibts leere Gruppen? werden die richtig migriert?


wbinfo:
wbinfo -u    (listet alle user)
wbinfo -g    (listet alle groups)

'Zeile' aus passwd
   wbinfo -i USER
   wbinfo --user-info=USERNAME
'Zeile' aus group
wbinfo --group-info=GROUPNAME

Alle gidnumbers of user
wbinfo -r USER
wbinfo --user-groups=USER

wbinfo --pam-logon=sch42%'LinuxMuster!' (test pam login)
wbinfo --krb5auth=sch42%'LinuxMuster!'  (authenticat using kerberos)

wbinfo --all-domains
   BUILTIN
   LINUXMUSTER




Questions:
show/hidden bei klassen ist Attribut
(es gibt keine hiddenclass mehr)

Gibts irgendwas, was man quotieren müsste?
  Printerdaten? Seiten? pykota
  Schulkonsole Liste  
-> neu attribute im ldap erforderlich, welche

-> Überlegen

flag für adminclass: teacher
oder type=teacher (statt adminclass)
wenn eine gruppe für einen user mit der rolle teacher anlegt wird, dann ists eine solche

samba4 Fragen:
Gibts Useranzahlbeschränkung?
User und Gruppennamen gleich? Geht das?

Schulkonsole: 
Wo soll aufgeschrieben werden, wie user usw. abgefragt werden müssen, ...
-> --porcelain output

Idee:

machine parsable output für Listen, ...
--------------------------------------------------
Vorbild: git ... --porcelain
-> im human readable output auch FARBEN verwendbar für output

sub &message("error|warning|info",porcelain=1|0,$value);

Bei Liste Titelzeile, was an welcher Stelle was steht 
(z.B. ldapAttributname)

Ansprechpartner für Format: Kai W.
--------------------------------------------------


ext4 als Standard 


drucker in devices.txt mit anderer nummer


/etc/linuxmuster/printers in ldap nehmen?


index definieren im schema


id_mapping zeigen

# ldbsearch -H /var/lib/samba/private/idmap.ldb

Edit idmap.ldb: (https://wiki.samba.org/index.php/User_and_Group_management)

UID-Mapping:
1) Find sid with
   # wbinfo --name-to-sid <user>
   # wbinfo -n <user>
   ---> sid
2) # wbinfo --sid-to-uid <sid from 1)>
   # wbinfo -S <sid from 1)>
   ---> uidnumber
3) ldbedit -e emacs -H /var/lib/samba/private/idmap.ldb objectsid=<sid from 1)>


GID-Mapping
4) # wbinfo --user-sids=<usersid from 1)>
   The first is the user sid
   Then group sids follow



NT_STATUS_INVALID_SID
siehe https://lists.samba.org/archive/samba-technical/2011-November/080319.html



libnns winbind tut nicht

uidnumbers:

Todo: im ldap abspeichern/abrufen (momentan in /etc/linuxmuster/sophomorix/user/...)

- bei migration die alle setzen (uidNumber und gidNumer)
- beim neu anzulegenden user, ein eigenen Zähler hochzählen
  limit.
  (Defaultmäsig beginnen uidNumber/gidNumer bei etwa 3.000.000)
   Bei jedem ausgeführten id-Befehl wird die uidnumber um 2 erhöht.
   (scheinbar wird sie dynamisch erzeugt) 
  gruppe/user:
     gidnumer/uidnumer: gidNumber
     msSFU30NisDomain: linuxmuster ( bei LINUXMUSER.LOCAL)

Tests nach migration:

- OK: Bei welchen/wievielen Usern kann man sich mit dem firstpassword einloggen
  sophomorix-passwd --test-firstpassword

- uidNumber und gidNumber testen mit:
  id user (output parsen) und mit den Daten vor der Migration vergleichen
  -> Fehler melden: 

- Dürfen unix gid und uid dieselben vorkommen? 





funktion create userlist neu schreiben:

parameter:

loginnamenliste
klassenliste (auch lehrer)
alle role students
alle role teacher
default: eingeschränkt alle ou's



Idee:

viele befehle brauchen eine ou als option

sinnvoll wäre:

wenn mehrschulsystem konfiguriert ist, 
dann wird in den Befehlen die option --ou gefordert
ODER: 1) es wird IMMER ou gefordert
      2) wenn man nur eine hat, kann eine defeult OU in der config gesetzt werden 



############################################################
Schema
############################################################

Questions:

lDAPDisplayName  (wird zum befüllen benutzt)
adminDisplayName (tut nicht)


Changes:
1) ----------------------------------------
creationdate
tolerationdate
deactivationdate

oMSyntax 23 (Zeit) --> oMSyntax 64 (utf8 string)
attributeSyntax: 2.5.5.11 --> attributeSyntax: 2.5.5.12

See: https://technet.microsoft.com/en-us/library/cc961740.aspx

Benamung/Unterscheidung:

mailquota bei user mailquota
(Oder kann dasselbe attribut nochmals verwendet werden?)

mailalias bei user? oder kann diese Mailadresse schon eingetragen werden

############################################################
sophomorix-mail
############################################################
dovecot statt cyrus
dovecot 

was macht sophomorix-mail bisher:
- mailbox anlegen/löschen 
- info anzeigen:
  - wieviel speicher genutzt
  - forwards anzeigen
- Erstellen von /etc/aliases 
  aliases
  maillists

was ist zu tun?




############################################################
Set password age
############################################################

soll man das machen:

samba-tool domain passwordsettings set --max-pwd-age 0


############################################################
Set password of administrator
############################################################

samba-tool user setpassword Administrator

############################################################
DNS
############################################################

abhängigkeiten für DNS query testen


* Alle bisherigen abfragen??:
  samba-tool dns query localhost linuxmuster.local @ ALL -U administrator --password='Muster!'
  sophomorix-device --dns-show (nur sophomorix nodes und zones)

* DNS-Einträge anlegen:
  # samba-tool dns add localhost linuxmuster.local j1010p01 A 10.16.100.1 --password='Muster!' -U Administrator

  This adds: DN: DC=j1010-p01,DC=linuxmuster.local,CN=MicrosoftDNS,DC=DomainDnsZones,DC=linuxmuster,DC=local
  ObjectClass: dnsNode
  The IP 10.16.1.100 is in Attribute dnsRecord, Binary last 4 Bytes
  -> Zusatzattribute zu dnsNode können z.B. die Attribute cn, adminDescription, 

  # samba-tool dns zonecreate localhost 100.16.10.in-addr.arpa --password='Muster!' -U Administrator
         100.16.10  -> Erste 3 Oktetts in umgekehrter Reihenfolge
                    10 bleibt
                    0,16,32,48,...  
                       -> Momentan: 2. oktett der server IP (IP aus Datei)
                       -> Final: aus den setup-Daten /var/linuxmuster, ... legt thomas eine zonendatei an.
                    100 kommt von der Rechner IP
  ?????????????? Zeilenweise bei lesen nach %devices{'file'} zu jedem node eine Zone festlegen
  This adds: 
  DN: DC=210.170.10.in-addr.arpa,CN=MicrosoftDNS,DC=DomainDnsZones,DC=linuxmuster,DC=local
  ObjectClass: dnsZone
  -> Zusatzattribute zu dnsZone können z.B. die Attribute cn, adminDescription, 


  Deleting DNSNode with samba tool:
  # samba-tool dns delete localhost linuxmuster.local bsz-j1010p20 A 10.171.210.20 --password="Muster!" -U Administrator


#INFO# samba-tool dns serverinfo localhost
samba-tool dns zoneinfo localhost 100.16.10.in-addr.arpa --password='Muster!' -U Administrator


Tests:
apt-get install dns-utils

dig j1010-p01


nslookup
# nslookup name.linuxmuster.local
Return 0: not found, Retutn 0: found: kacke


lehrer.txt : eindeutige id nutzen


############################################################
Tree
############################################################





Forbidden OU's: SCHOOL, GLOBAL
Forbidden tokens: global, ---

############################################################
Migration:
############################################################


Three steps:
1) DUMP: run sophomorix-dump on old server
    (dumps to /root/sophomorix-dump)
2) copy the dir /root/sophomorix-dump recursively to new server/stick
3) SUCK IT IN: sophomorix-vampire --datadir /path/to/dumped/dir

to do: add option --restore-config-files (update wiki)
   use config file instead of list in script
test sophomorix-dump on school server
sophomorix dump: warn when target dir exists

role hiddenclass?
bz is in forbidden login hash -> /etc/group
   -> sophomorix-add shows show with option -i name clashes from fixed uidnames
log when a user cannot be created (summary in the end of script)
use project dump to create projects (is all info there)

add encrypted passwords to sophomorix.add
old: 
   userpassword          {SSHA}oTOa69my8cTkVa97XVDVeiJr3Ctmd0JHeS9RMC5SUkV4cElzQmlDa2k5QWtBdjFPek1Dbw== 
                         {CRYPT}QByepZzk6naTo
   sambalmpassword
      FFCA9D16DCB26848AAD3B435B51404EE
   sambantpassword
      CA7D70A5587A194B83A4C4D325ED1C44
new: 
   unicodePwd
  
Migration:

die mit AD_ou_add angelegten gruppen müssen eine gid bekommen
teachers: 10000 bei migration


add ldif file that updates
unicodePwd AND sophomorixFirstPassword
add option to sophomorix-vampire

Tasks to do after migration:
projects: add displayname

Bugs after Migration tests: 
------------------------------
sophomoriy-user cannot show  

sophomorix-project -i -p mkk_abt3
WARNING: sce seen twice! Remove one of them!

agoruom ist a workstation

sophomorix-class -i -c klasse:
- zeigt das user als member raus müssen.

nach sophomorix.add muss 

#-> und die admins aus 
#   sophomorix-dump/data/root/sophomorix-dump-viewdumps/memberdata_view.sql
#   nach sophomorixAdmins
#   (mit dem sophomorix-Befehl)
#-> alle mit adminclass teacher sind admins in der gid
#   wenn user, die nicht in adminclass teachers sind in anderen gruppen admins sind,
#   ---> script erzeugen um diese nachzutragen

############################################################
Scripts
############################################################

Allgemein:

Man kann wohl nicht eine unicode string mit "" (empty) füllen
-> Attribute entfernen? wenn --comment ""
-> oder was sonst reinschreiben?




AD_group_addmember
 add user to group only if they are not member already
 add group to group only if they are not member already


sophomorix-project

add groups with role 'project'
  - p_name (no school).
  - projects can contain students of all schools
  - project name length
  - p_longname: description field used
  - Zeitanzeige lesbarer machen (-i -p <name>)

Oberstufenkurse, wahlweise mit der ID
http://www.linuxmuster.net/wiki/anwenderwiki:sophomorix:sophomorix-project
  - zusammen mit dem Schlerdatenexport  auch oberstufenexport exportieren
  - sync betrachten



sub AD_user_move {
add created schools to list


Tests:

if user is admin and should be member -> degrade user
if user is member and should be admin -> upgrade user
           member AND admin -> throw error
dito for groups

--members/admins  nonexisting user -> dont add user 


option sync memberships: go throuh all projects and sync memberships


sophomorix-user
 OK: options to change status
     Todo: update dates
 option to list new teachers
how to handle users that are organised in wrong school
  i.e. sophomorisSchoolname is BSZLEO an they are in OU=SCHOOL 

sophomorix-class
(migrate similar to projects)
- add option to create class (like*-project) --create
  --hide (sets type adminclass to hiddenclass)
  --quota
  --mailquota
  --mailalia
  --maillist
  --description ?  "migrated on $date"  
  --admins
  --admingroups
  (members are managed automatically)
create tests for that (sophomorix-test-4)

count current members (CM) and show then with -i option before MM
or one column: CM/MM -> 32/0

display type (T=teacher3,S=students)
display hidden

--info to display that (show classes like projects now)
sophomorix-vampire creates missung groups:
  --> hiddenclasses
  --> classes without students
  ---> and updates them (i.e. groups created by sophmorix-add)
Think about: create classes first, then the users automatically (avoids name clash)

add --info --class <class>


-> sophomorix-device

-> hardwareklassen gruppen bauen

-> leere rooms löschen

macadress in den ldap: https://msdn.microsoft.com/en-us/library/windows/desktop/ms676850%28v=vs.85%29.aspx


add/move/kill
-> logfiles adding, deletion, killing
-> Option -i: 
     - add a table per OU/token 
     - kill user markes with K

sophomorix-kill:
  list of groups tha will never be Killed
  - attic
  - teachers
  - students
  - Windows administrators groups

sophomorix-project
  -> create all groups with role=project
 
Attributes for a group






sophomorix-useradd
  - replace default password 'linux' with 'LinuxMuster!'
  - maybe put all options for adding users  to sophomorix-add

sophomorix-add:   
call sophomorix-print correctly 
--user --comment "" does not work ()
--user --webui-dashboard "" does not work


format of sophomorix.add, .move, .kill
   - use utf8 in these files 
   - allow user to be added with special quota

sophomorix-schools.conf
     use unid in 5th field (yes no)
       --> sinnvole Warnung in office.report: unid expected 
     from_age, to-age (instead of from_year to year)
     expect_login_name (bei teacher.csv: YES, NO: generiere)
       --> sinnvole Warnung in office.report: login expected 

############################################################
sophomorix-passwd

auflisten von Passwörtern, die ablaufen?

tun unicode passworter? evtl. in _unipwd_from_plainpwd von latin1 nach utf8 umstellen

Password-length:
sophomorix-add, sollte mit 
    samba-tool domain passwordsettings show  (dauer 0,3 sekunden)
die passwortlänge abfragen (evtl. mehr???) und kürzer Konfigurierte Passwort-Längen 
ausschließen
-> Funktion config_sophomorix_read mit option (get_passwordsettings)
   liest zusätzlich pwd_settings ein (auf performanzgründen nicht immer)

config_sophomorix_read auf hashs als parameter umstellen



Wenn alte, kurze Passwörter als firstpasswords eingespielt werden (complexity and length abgemildert)
Dann tut das zurücksetzen of das erstpasswort nicht mehr (wenn abmilderung wieder aufgehoben)

https://www.ostechnix.com/check-password-complexity-linux/
   # sudo apt-get install libcrack2
   # echo "Welcome1" | cracklib-check

Lösungen?

1) bei jedem Firstpasswort LmL! davorsetzen, aber den alten hash einmal einpflegen.
--> altes pwd tut
--> wenn zurückgesetzt, dann geht das auch, weil passwort komplex genug
--> Nachteil: alte ausgedruckte Kärtchen zun nicht

2) BESSER: neue firstpasswords , den complexity rules entsprechend wählen
--> altes password tut, falls user das noch kennt
--> falls passwort zurückgesetzt wird, dann auf das neue komplexe

############################################################
sophomorix-newfile

encoding als attribut reinspeichern?

ansonsten: siehe neuer workflow


############################################################
sophomorix-check

doku: Erlaubte Zeichen Vorname/Nachname/Klasse/Geburtsjahr:
siehe check_class
      check_first
      check_last
      check_birthdate
in sophomorix-check

--injectline "Klasse;Nachname;Vorname;Gebdat" --school
  fügt die Zeile (Unicode) 
     NACH den Plausibilitätstest und utf8 codierung ein
     --> testen des Anlegens von usern auf der Kommandozeile
         (Dateien unter /etc bleiben unverändert beim test)
     --> auch zum selbstanlegen von usern in der Schulkonsole geeignet


???? statt teach-in:
--ask-me
  --> jedes Ähnlichkeitsmatch mit ja/nein beantworten
      approx-match Level angeben



my %AD= %$ref_AD;  muss das so sein? kopiert das den hash unötigerweise?
(auch in anderen scripten soverwendet)

wenn user nicht die Rolle student,teacher hat, ist er nicht im AD_hash drin.
--kaputte Rolle> sophomrixRole="teach" -> nicht im AD 

ERROR usw. bei read_config


--tests:

--filter
  mitgelieferte Filter sollten auf alle files anwendbar sein.
  jetzt ist absoluter input und output path hardcordiert
  


-- kann man Felderreihenfolge selbst bestimmen?
   -> auto im Filter-Feld erstellen
   -> Zeilentrenner bestimmen (in jeder Zeile gleich oft, 4-6 mal)
      -> Vornamen aus Vornamenlise, Nachnamen aus Nachnamenliste
      - Geburtstag mit Ziffern
      - Eindeutiges Feld: unid

   -> Trenner ermitteln

--analyze-file /path/to/file --use-filter /path/to filter

--extrastudents.csv erzeugt Dateien in ../tmp wie nach Filter

--list-filter (and exit) 

Einlesen der Daten

1) Filter oder Copy anwenden
   extraclasses -> user generieren

(Ende von sophomorix-check --filter-only)

2) Lauf durch Dateien: 

   A) Einlesen in 
      %users_file

      (oder file -> Line -> als EINDEUTIGE stelle?)


      identifier -> <identifier>    OK: FIRSTNAME
                                    OK: SURNAME
                                    OK: BIRTH
                                    OK: UNID
                                    OK: FILE
                                    OK ZEILE_OLD
                                    ... passwort length, ... auch? was in .update, .move, .add kommen würde?
                                    COUNT -> wie oft wurde dieser identifier gesehen
                                    STATUS -> ok, Vorname unerlaubtes Zeichen, ..... 

     lookup oder Full?      
     unid  -> <unid> IDENTIFIER ->
     dateiname -> Zeilennummer -> LINE_ORIG -> unmodifiziert
                               -> LINE_FIXED -> mod, utf8
                               -> identifier
                               -> unid
                               und später
                               -> LINE_ADD
                               -> LINE_UPDATE
                               -> LINE_MOVE
                               -> LINE_KILL (gibts nicht)
     Klassenweise user

?????????????? Weiter: .... ermitteln. alles für .add, move, ... update

handling of filter script checken
cp checken (mkdir)
danach gefiltertes einlesen
Atlantis- filter incorperieren ind git

do that really?
remember may lines in hash,
go through all lines
write them to file if correct
writing file .../tmp/*.filter.utf8


Zeile alt, Zeile neu

     Identische Zeilen -> log, Warning, ...



   B) Vornamen (+Nachnamen) auf encoding testen


3) Lauf durch den hash, jeder entry
   mit dem gefundenen encoding
   FIRSTNAME_UTF8 usw. dazu
   sowie LINE_FIXED (gibts doppelungen?)


4) korrigierte Zeilen ausgeben: *.csv.filter.utf8

(Ende von sophomorix-check --analyze)
Option (zum debuggen: --show-line students.csv:20

5) Lesen der systemdaten 
   vorhandene Loginnamenliste erzeugen

6) vergleichen (Reihenfolge)
   Linien Durchgehen 1-x

   im hash .add .move .kill .update erstellen

   .kill: sofort entfernbar
   .move: andere Klasse, andere Schule (AD Umbau, Klassen und Gruppenzugehörigkeiten)
   .update (Account internes update: Namen, Status, Duldung)
   .add neu hinzu

7) Linien in datei schreiben (wieso nicht gleich?)
   Deswegen: debuggen
   Option: --follow students.csv:20
   Zeigt:
   students.csv OLD:   ....
   students.csv NEW
   sophomorix.add: ... Zeile oder Titel=Rest
   sophomorix.update:
   sophomorix.move:
   sophomorix.kill:
   System: dump of Values

todotodotodo:???????????????????????????????????????
sophomorix-check:

sind sn und givenName im AD falsch herum?
sophomorixBirthdate wird korrekt gelesen?
ist das OK? -> anderes Format
sophomorixPrefix ist undef?
AD_get_AD

auch teacher ermitteln
und andere Rollen (rollenliste bei der ldapsuche aus sophomorix.ini)
speichern nach rollen,
identifier
unid

andere suchen (computer) so umstellen, dass es keine zwischenvariablen gibt
(spart füllen einer variablen, Beispiel siehe user)


Idee: Zeile für Zeile durchgehen und ermitteln was zu tun ist:

1) exakt passende matches
- alle Zeilen durchgehen
- unid match ODER id match 
  -> testen auf move (sub)
  -> testen auf update (sub)
     (TESTEN BEI MIGRATION mit und ohne unid(unid weglöschen))
-> ohne match: 
   neu anzulegen im hash: proposed_add


2) ermitteln der zu löschenden user
   neu anzulegen im hash: proposed_delete

3) approx-match der id
  proposed_add und proposed_delete
  -> automatisch matchen
     &automatch_line();
     -> alle delete durchgehen
        -> approx-match
           evtl. ermittel wie approx beide sind 
  -> testen auf move (sub)
  -> testen auf update (sub)

- gar kein match zu vorhandenen:
  -> add
- übrigbleibende:
  -> toleration
  -> deactivation
  -> kill


Problem: eine Zeile kann MEHRERE Zeilen verursachen, z.B. Versetzung UND Namenskorrektur
??? Zusammenfassen in sophomorix-update (-move gibts dann nicht mehr???)
Egal in welcher Reihenfolge, es sollte 


userAccountControl
---------------------------
enabled/disabled
Passwort change ja, nein
Passwort expires

was braucht man davon

enabled Account: 512, so wird jetzt hardcoded ein user angelegt
disabled Account: 514, 

samba-tool user disable <username>

stellt auf 514 um, wie hier beschrieben:

http://www.selfadsi.de/ads-attributes/user-userAccountControl.htm

samba-tool user enable <username> stellt wieder auf 512 zurück

Umsetzen:
1) userAccountControl (dezimal) lesen
2) Binär umwandeln
3) schauen welche Bits gesetzt sind
4) Daraus gewünschte Einstellungen erkennen (enabled, password expires, ...)
5) prüfen ob was verändert werden muss:
     - enablen/disabeln je nach sophomorixStatus und dazugehörige Zeiten
     - passwort expires, ... falls in school.conf so konfiguriert
6) in sophomorix.update schreiben
7) mit sophomorix-update umsetzen


Resultat für Encoding:

A) keine Sonderzeichen -> ASCII
B) wiederspruch -> UNDETECTABLE
C) sicher Festgestellt -> UTF(, ...   

Benutzersynchronisation, Reihenfolge:

1) Matches suchen: .update .move

A) unid aus Datei gibts im system 
     a) alle Daten gleich -> nix tun
        (evtl aus dem hash löschen, nächste schleife performanter)
     b) ein paar Daten unterschiedlich 
          Klasse gleich: *.update
          Klasse verschieden: *.update und move
     c) Daten sehr unterschiedlich -> warnung, ohne update

B) unid aus Datei gibts nicht im system, aber in  Dateien
     a) identifier gleich -> *.update zum unid hochladen 
        (umstellung auf unid, evtl. option unid hochladen)

     b) ohne unid, identifier gleich, klasse gleich 
        -> nix tun

     c) identifier ahnlich -> update
 
2) Neue suchen         (mit unid -> .add)
3) zu Löschende suchen (mit unid -> kill)

4) ohne unid: 
   Dateien für sophomorix-teach-in erstellen
   .add, -> .update (tolerate,deactivation date) or .kill
5) Do it, oder sophomorix-teach-in 

sophomorix-quota
- option --show-non-default-quota
         --show-non-default-mail-quota
  zeigt alle vom default abweichende quota von
  --user
  --adminclasses
  --projects
  evtl. auch einzeln

sophomorix-quota workflow:

1) Für alle user:
   @userlist erzeugen (am ende sort)
   Alter Wert sophomorixQuota aus AD holen, zerlegen in einen hash:
   %old_quota
      -> samAccount
      -> school 
        -> sophomorixQuota           (Attribut)
        -> target_user -> 8000|---   (Sollwert der users)
        -> target_calc -> 8000       (alter berechneter Wert)
        -> quota -> failed|2997|...  (Realer Wert)

     sophomorixQuota Attribut
     -> 'empty' 
     -> 'school:target_user:target_calc:failed'   i.e.: bsz:---|3000:failed
     -> 'school:target_user:target_calc:quota'    i.e.: bsz:7000:7000:6997
   @sort @userlist


2) neue Quota für alle user berechnen:
   * school-default
   * adminclass
   * project additions

   --> ergibt für jeden user/schule ein Wert in MB (Sollwert, target_value)
       (struktur wie bei %old_quota, jedoch %new_quota)

   %new_quota -> samAccount -> school -> target_calc -> 3000
                                      -> target_calc_info -> SD|CD|SDP|CDP
                                      -> school -> 1000
                                      -> adminclass -> 2000
                                      -> project_add -> project1 -> 2000
                                                     -> project2 -> 800
                                      -> user   

3) Entscheiden ob update erforderlich:

   A) old quota target value exists
      AND old quota target_value = new quota_target value
      AND quota not failed
      AND quota within x% of target_value
      -> do nothing 
   B) else
      --> setzen, prüfen, updaten
      1) smbcquota mit target_value absetzen
      2) return auswerten, if OK, weiter else failed
      3) gesetztes quota mit smbcquota abfragen
      4) if gesetztes quota innerhalb x%, weiter else failed
      5) sophomorixQuota updaten 

sophomorix-quota --info 
                 --school <school> (nur user 1er schule)
                 --updates-only (failed and calc ne target)
                 --use-smbcquota (use smbcquota to query quota) 
                   display full info of smbcquota 

-> alle user durchgehen
-> sophomorixQuota abfragen

Auflisten:
userlogin | OK | global | calc | target_value | quota
userlogin | !! |school1 | calc | target_value | failed 
userlogin | OK |school2 | calc | target_value | quota 

calculated: SD=3000
            CD=5000
            SDP=8000
            CDP=9000
wobei SD=school-default, CD=Class-default, +P=project modifiedsop	

Umsetzung:
OK: sophomorixQuota setzen für gruppen (sophomorix-project, sophomorix-class)
OK: sophomorixQuota setzen für user (sophomorix-user)

1. sophomorix-quota
   projects-quota-memberhash
   project -> sambasamaccount (membergroups auflösen, loop vermeiden) 
   Quotaberechnung neu
   --info gibt die Berechnung aus(-ij als json):
   Schulweise (option --school) reduziert
   Default: Schule
   Classquota (nur abweichende)
   Projectquota (nur abweichende)
   Einzelquota (nur abweichende)
2. quota setzen und updaten


Todo:
- tut sophomorix-user --quota auch für admins -> fixen von sophomorix-admin
- quota user test in allen tests ergänzen
- zeigen wenn quota auf andere schulen zeigen
- zeigen wenn quota auf nichtexistierende smb shares zeigen



sophomorix-print:

     - Full utf8 support
       (Firstnames, Surnames will be utf8 encoded)
     - add support for templates
       see pull requests for sophomorix2

sophomorix-howcanihelp
- unbekannte Vornamen, Nachnamen melden5. quotaberechnung alt
- ... 

sophomorix-belwue:

Konten erstellen nur zum Mailversand per belwue: scanner@xyz.de (löschen eingehender mails, daily/weekly)
NUR-Mailversand Konten, z.B. Sekretärinnen
  * Konto bei belwue
  * kein Konto im pädagogischen Netz 

sophomorix-class
 - mit useranzahl listen
 - bereich angeben um einzuschränken (z.B. über x user)


############################################################
all scripts
############################################################

testen:
wenn falsche codierung geforced wird, sollte enweder
- problematische accounts nicht angelegt werden
- problematische abccounts korrect angelegt werden (fehlerhafte zeichen in utf8 Felder)   
  Bei richtiger codierung werden fehler behoben
  
wenn man mit * sucht: 
sophomorix-class -i -c class1*
sophomorix-project -i -c pro*
soll das auch gehen

soll das auch für Änderungen gehen?

CSV-Tags entfernen:
grep '\$Id\$' -ir ./


when die (file missing), tell what file is missing 

show ldap search filer on -v (loglevel =>2)

/usr/sbin/sophomorix-class started ... usw: in loglevel -v verschieben

############################################################
Janitor scripts
############################################################

check if user is in more groups of type class

############################################################
AD Browser
Apache Directory Studio
Paket machen incl. java?
############################################################

package install: braucht man den Aufruf von mandb?
A) englische manpages erstellen, da sie als fallback dienen
B) Hinweis -> Englisch, please translate

